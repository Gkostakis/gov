<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ECO.SYSTEM.OS — Governance Mapper</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sunflower:wght@300;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://unpkg.com/3d-force-graph@1.73.4/dist/3d-force-graph.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}

:root {
  --font: 'Sunflower', 'Helvetica Neue', sans-serif;
  --bg:        #000000;
  --canvas-bg: #050505;
  --panel:     #282828;
  --panel2:    #1c1c1c;
  --border:    rgba(215,215,215,0.08);
  --border-hi: rgba(215,215,215,0.16);
  --text:      #d7d7d7;
  --text-dim:  rgba(215,215,215,0.45);
  --text-muted:rgba(215,215,215,0.25);
  --accent:    #2203ff;
  --accent-lo: rgba(34,3,255,0.12);
  --accent-bd: rgba(34,3,255,0.35);
  --accent-hi: #4433ff;
  --white:     #ffffff;
  --black:     #000000;
  --red:       #ff3b3b;
  --green:     #00c87a;
  --radius:    5px;
}

body {
  font-family: var(--font);
  font-weight: 300;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  font-size: 13px;
  letter-spacing: 0.02em;
}

/* ══ TOOLBAR ══════════════════════════════════════════════ */
#toolbar {
  display: flex;
  align-items: center;
  gap: 0;
  padding: 0;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  z-index: 100;
  height: 44px;
  position: relative;
}
#toolbar::after {
  content:''; position:absolute; bottom:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg, var(--accent) 0%, transparent 50%);
  opacity: 0.8;
}

/* Brand */
.brand {
  display: flex;
  align-items: center;
  padding: 0 18px 0 16px;
  border-right: 1px solid var(--border);
  height: 100%;
  gap: 0;
  flex-shrink: 0;
  cursor: default;
  user-select: none;
}
.brand-name {
  font-family: var(--font);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--white);
  white-space: nowrap;
}
.brand-name em {
  color: var(--white);
  font-style: normal;
}
.brand-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--white);
  margin: 0 8px;
  opacity: 0.4;
  flex-shrink: 0;
}

/* Toolbar Groups */
.tb-group {
  display: flex;
  align-items: center;
  gap: 2px;
  padding: 0 8px;
  height: 100%;
  border-right: 1px solid var(--border);
}
.tb-group.right {
  border-right: none;
  border-left: none;
  padding: 0 10px 0 6px;
  gap: 4px;
}

/* Buttons */
.btn {
  font-family: var(--font);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  padding: 0 12px;
  height: 28px;
  border-radius: var(--radius);
  border: 1px solid transparent;
  background: transparent;
  color: var(--text-dim);
  cursor: pointer;
  transition: all 0.12s;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  line-height: 1;
  position: relative;
}
.btn:hover {
  background: rgba(215,215,215,0.06);
  color: var(--text);
  border-color: var(--border-hi);
}
.btn:active { background: rgba(215,215,215,0.1); }
.btn.active {
  background: var(--accent-lo);
  color: var(--accent-hi);
  border-color: var(--accent-bd);
}
.btn.primary {
  background: var(--accent);
  color: var(--white);
  border-color: var(--accent);
  font-weight: 500;
}
.btn.primary:hover { background: var(--accent-hi); border-color: var(--accent-hi); }
.btn.danger { color: var(--red); }
.btn.danger:hover { background: rgba(255,59,59,0.1); border-color: rgba(255,59,59,0.3); color: var(--red); }
.btn-icon {
  width: 28px; height: 28px; padding: 0;
  display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0;
}

/* Dropdown wrapper */
.drop-wrap { position: relative; display: inline-flex; }
.dropdown {
  position: absolute; top: calc(100% + 6px); left: 0;
  background: var(--panel);
  border: 1px solid var(--border-hi);
  border-radius: var(--radius);
  box-shadow: 0 12px 40px rgba(0,0,0,0.7);
  padding: 4px;
  z-index: 500;
  display: none;
  flex-direction: column;
  min-width: 180px;
  animation: dropIn 0.14s cubic-bezier(0.34,1.56,0.64,1);
}
.dropdown.right-align { left: auto; right: 0; }
.dropdown.show { display: flex; }
@keyframes dropIn {
  from { transform: translateY(-6px) scale(0.97); opacity: 0; }
  to   { transform: translateY(0) scale(1); opacity: 1; }
}
.drop-item {
  font-family: var(--font); font-size: 11px; font-weight: 300;
  padding: 7px 10px; border-radius: 3px; border: none;
  background: transparent; color: var(--text-dim); cursor: pointer;
  transition: all 0.1s; white-space: nowrap;
  display: flex; align-items: center; gap: 8px;
  text-align: left;
}
.drop-item:hover { background: rgba(215,215,215,0.06); color: var(--text); }
.drop-item.active { color: var(--accent-hi); }
.drop-item .di-check { color: var(--accent); font-size: 10px; min-width: 10px; }
.drop-sep {
  height: 1px; background: var(--border); margin: 3px 4px;
  display: block;
}
.drop-header {
  font-size: 9px; font-weight: 500; letter-spacing: 1.2px;
  text-transform: uppercase; color: var(--text-muted);
  padding: 5px 10px 3px; cursor: default;
}

/* Canvas bg color button */
#bg-color-wrap { position: relative; display: inline-flex; }
#bg-color-input { position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; border: none; padding: 0; }
#bg-color-swatch {
  width: 8px; height: 8px; border-radius: 1px;
  border: 1px solid rgba(255,255,255,0.2); background: #050505;
  position: absolute; bottom: 4px; right: 4px; pointer-events: none;
}

/* Search */
#search-wrap { position: relative; width: 200px; flex-shrink: 0; }
#search {
  font-family: var(--font); font-size: 12px; font-weight: 300; letter-spacing: 0.04em;
  padding: 6px 12px 6px 32px; border: 1px solid var(--border); border-radius: var(--radius);
  outline: none; width: 100%; background: rgba(0,0,0,0.4); color: var(--text);
  transition: all 0.15s;
}
#search:focus { border-color: var(--accent-bd); background: rgba(34,3,255,0.04); }
#search::placeholder { color: var(--text-muted); }
#search-wrap::before {
  content: '⌕'; position: absolute; left: 9px; top: 50%;
  transform: translateY(-50%); color: var(--text-muted); font-size: 14px; pointer-events: none;
}

/* ══ FILTER BAR ═══════════════════════════════════════════ */
#filter-bar {
  display: flex; align-items: center; gap: 4px;
  padding: 5px 14px;
  background: var(--black);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  overflow-x: auto;
  transition: max-height 0.22s ease, opacity 0.18s, padding 0.2s;
  max-height: 40px; opacity: 1;
}
#filter-bar.hidden { max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; pointer-events: none; }
#filter-bar::-webkit-scrollbar { height: 2px; }
#filter-bar::-webkit-scrollbar-thumb { background: var(--border-hi); border-radius: 2px; }
.filter-label { font-size: 9px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); white-space: nowrap; flex-shrink: 0; }
.fsep { width: 1px; height: 18px; background: var(--border); margin: 0 4px; flex-shrink: 0; }
.fchip {
  font-family: var(--font); font-size: 9px; font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase;
  padding: 2px 9px; border-radius: 3px; border: 1px solid var(--border);
  background: transparent; color: var(--text-muted); cursor: pointer; transition: all 0.1s; white-space: nowrap; flex-shrink: 0;
  display: inline-flex; align-items: center; gap: 4px;
}
.fchip:hover { border-color: var(--border-hi); color: var(--text-dim); }
.fchip.active { background: var(--accent-lo); color: var(--accent-hi); border-color: var(--accent-bd); }
.fchip .fcount { color: var(--text-muted); font-size: 8px; font-weight: 300; }
.fchip.active .fcount { color: var(--accent); }
#filter-status-sel {
  font-family: var(--font); font-size: 9px; font-weight: 500; letter-spacing: 0.3px;
  padding: 2px 22px 2px 8px; border-radius: 3px; border: 1px solid var(--border);
  background: transparent url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='6' viewBox='0 0 8 6'%3E%3Cpath d='M1 1l3 3 3-3' stroke='%23888' stroke-width='1.2' fill='none'/%3E%3C/svg%3E") no-repeat right 6px center;
  color: var(--text-muted); cursor: pointer; outline: none; appearance: none;
}
#filter-status-sel.active { background-color: var(--accent-lo); color: var(--accent-hi); border-color: var(--accent-bd); }
#filter-tag-input {
  font-family: var(--font); font-size: 9px; font-weight: 300; letter-spacing: 0.3px;
  padding: 2px 8px; border-radius: 3px; border: 1px solid var(--border);
  background: transparent; color: var(--text-muted); outline: none; width: 110px; transition: all 0.15s;
}
#filter-tag-input:focus { border-color: var(--accent-bd); color: var(--text); width: 150px; }
#filter-tag-input::placeholder { color: var(--text-muted); }
#btn-orphan-filter { }
#btn-clear-filters {
  font-family: var(--font); font-size: 9px; font-weight: 500; letter-spacing: 0.5px;
  padding: 2px 9px; border-radius: 3px; border: 1px solid rgba(255,59,59,0.2);
  background: transparent; color: rgba(255,59,59,0.6); cursor: pointer; transition: all 0.1s; white-space: nowrap; flex-shrink: 0; text-transform: uppercase;
}
#btn-clear-filters:hover { background: rgba(255,59,59,0.08); color: var(--red); }

/* ══ CANVAS ═══════════════════════════════════════════════ */
#canvas-wrap { flex: 1; overflow: hidden; position: relative; }
svg#graph { width: 100%; height: 100%; background: var(--canvas-bg); cursor: grab; }
svg#graph:active { cursor: grabbing; }
#graph-3d { width: 100%; height: 100%; display: none; position: absolute; top: 0; left: 0; }

/* Node classes */
.node-group { cursor: pointer; }
.node-circle { transition: opacity 0.2s; }
.node-group.highlighted .node-circle { filter: url(#glow-bright); }
.node-group.dimmed .node-circle { opacity: 0.05 !important; }
.node-group.dimmed .node-label  { opacity: 0.05 !important; }
.node-group.selected-node .node-circle { stroke-width: 2.5 !important; filter: url(#glow-bright); }
.node-label {
  font-family: 'Sunflower', sans-serif; font-weight: 500;
  fill: #ffffff; pointer-events: none; text-anchor: middle; dominant-baseline: auto;
}
.link-path { fill: none; stroke-linecap: round; transition: opacity 0.25s; }
.link-path.dimmed { opacity: 0.06; }
.link-label-bg { fill: var(--black); pointer-events: none; }
.link-label-text {
  font-family: 'Sunflower', sans-serif; font-weight: 300;
  font-size: 9px; fill: rgba(215,215,215,0.5); pointer-events: none; text-anchor: middle; dominant-baseline: middle;
}
.pin-ring { fill: none; stroke: rgba(34,3,255,0.6); stroke-width: 1.5; stroke-dasharray: 3 2; pointer-events: none; }

/* Zoom fit */
#btn-zoom-fit {
  position: absolute; bottom: 16px; left: 16px; z-index: 50;
  width: 30px; height: 30px; border-radius: 4px;
  border: 1px solid var(--border-hi);
  background: rgba(0,0,0,0.85); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.7); padding: 0; transition: all 0.15s;
}
#btn-zoom-fit:hover { border-color: var(--accent-bd); background: rgba(34,3,255,0.1); }
#btn-focus-exit {
  position: absolute; top: 14px; left: 50%; transform: translateX(-50%);
  z-index: 50; display: none;
  font-family: var(--font); font-size: 10px; font-weight: 500; letter-spacing: 0.5px;
  padding: 5px 14px; border-radius: 20px; border: 1px solid var(--accent-bd);
  background: rgba(0,0,0,0.9); color: var(--accent-hi); cursor: pointer;
  backdrop-filter: blur(8px); text-transform: uppercase;
}
#btn-focus-exit:hover { background: var(--accent-lo); }

/* Empty hint */
#empty-hint {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  text-align: center; pointer-events: none; transition: opacity 0.4s; user-select: none;
}
#empty-hint .big-brand {
  font-family: var(--font); font-size: 38px; letter-spacing: 8px; font-weight: 700;
  color: rgba(40,40,40,0.9); text-transform: uppercase; margin-bottom: 10px;
}
#empty-hint p { font-size: 11px; font-weight: 300; line-height: 2; color: rgba(40,40,40,0.7); }
#empty-hint strong { color: rgba(70,70,70,0.9); font-weight: 500; }

/* ══ STATUS / FOOTER ══════════════════════════════════════ */
#statusbar {
  padding: 0 14px; font-size: 9px; color: var(--text-muted);
  background: var(--panel); border-top: 1px solid var(--border);
  display: flex; gap: 18px; flex-shrink: 0; align-items: center;
  height: 24px; letter-spacing: 0.05em;
}
.stat-item { display: flex; align-items: center; gap: 5px; }
.stat-key { text-transform: uppercase; letter-spacing: 0.8px; font-size: 8px; font-weight: 500; color: rgba(215,215,215,0.18); }
.stat-val { color: rgba(215,215,215,0.4); font-weight: 300; }
#focus-indicator { color: var(--accent); font-weight: 500; font-size: 8px; letter-spacing: 1px; text-transform: uppercase; display: none; }
.stat-accent { margin-left: auto; color: rgba(215,215,215,0.15); font-size: 8px; letter-spacing: 0.3px; }

#footer {
  padding: 0 14px; font-size: 8px; color: rgba(215,215,215,0.15);
  background: var(--black); border-top: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
  height: 20px; letter-spacing: 0.3px; flex-shrink: 0;
}
#footer .footer-left { font-style: italic; font-weight: 300; }
.footer-version { color: var(--accent); opacity: 0.5; letter-spacing: 1.5px; font-weight: 500; font-size: 9px; }

/* ══ TOOLTIP ══════════════════════════════════════════════ */
#tooltip {
  position: fixed; background: rgba(0,0,0,0.92); color: var(--text);
  border: 1px solid var(--border-hi);
  font-family: var(--font); font-size: 11px; font-weight: 300;
  padding: 10px 13px; border-radius: 5px;
  pointer-events: none; opacity: 0; transition: opacity 0.12s;
  z-index: 9999; max-width: 240px; line-height: 1.8;
  backdrop-filter: blur(4px);
}
#tooltip.show { opacity: 1; }
#tooltip .tt-name { font-size: 12px; font-weight: 700; color: var(--white); display: block; margin-bottom: 4px; }
#tooltip .tt-row { display: flex; align-items: baseline; gap: 7px; }
#tooltip .tt-key { color: var(--text-muted); font-size: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.8px; min-width: 60px; }
#tooltip .tt-val { color: var(--text-dim); font-size: 10px; }
.type-badge { display: inline-block; font-size: 7px; font-weight: 700; padding: 1px 5px; border-radius: 2px; letter-spacing: 0.5px; text-transform: uppercase; }

/* ══ NOTIF ════════════════════════════════════════════════ */
#notif {
  position: fixed; bottom: 22px; left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--panel); border: 1px solid var(--border-hi);
  color: var(--text); font-family: var(--font); font-size: 11px; font-weight: 300;
  padding: 8px 20px; border-radius: 20px; z-index: 9999;
  transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s;
  opacity: 0; pointer-events: none; box-shadow: 0 6px 24px rgba(0,0,0,0.7);
}
#notif.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* ══ OVERLAY PANEL ════════════════════════════════════════ */
#overlay-panel {
  position: absolute; top: 0; right: 0; width: 290px; height: 100%;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border-left: 1px solid var(--border);
  z-index: 40; display: flex; flex-direction: column;
  pointer-events: none; opacity: 0; transform: translateX(10px);
  transition: opacity 0.25s ease, transform 0.25s ease;
}
#overlay-panel.visible { opacity: 1; transform: translateX(0); pointer-events: auto; }

#overlay-tabs {
  display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0;
  background: rgba(0,0,0,0.5);
}
.ov-tab-btn {
  font-family: var(--font); font-size: 8px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase;
  padding: 0; height: 34px; border: none; background: transparent;
  color: var(--text-muted); cursor: pointer; transition: all 0.15s; flex: 1;
  border-bottom: 1px solid transparent; margin-bottom: -1px;
}
.ov-tab-btn:hover { color: var(--text-dim); }
.ov-tab-btn.active { color: var(--white); border-bottom-color: var(--accent); }
.ov-tab-content { display: none; flex: 1; overflow: hidden; flex-direction: column; }
.ov-tab-content.active { display: flex; }

/* PROPERTIES TAB */
#ov-tab-properties { overflow-y: auto; }
#prop-panel-empty {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  height: 100%; gap: 8px; padding: 30px 20px; text-align: center;
}
#prop-panel-empty .prop-empty-icon { font-size: 28px; color: rgba(215,215,215,0.08); }
#prop-panel-empty p { font-size: 10px; font-weight: 300; color: var(--text-muted); line-height: 1.8; }
.prop-content { padding: 16px; }
.prop-name { font-size: 15px; font-weight: 700; color: var(--white); margin-bottom: 10px; line-height: 1.3; word-break: break-word; }
.prop-badges { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 12px; }
.prop-badge {
  font-size: 8px; font-weight: 500; padding: 2px 7px; border-radius: 2px;
  letter-spacing: 0.5px; text-transform: uppercase;
}
.prop-imp-bar { margin-bottom: 14px; }
.prop-imp-label { font-size: 8px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; display: flex; justify-content: space-between; }
.prop-imp-label span { color: var(--accent-hi); font-size: 11px; font-weight: 700; }
.prop-imp-track { height: 2px; background: var(--border); border-radius: 1px; overflow: hidden; }
.prop-imp-fill { height: 100%; background: var(--accent); border-radius: 1px; transition: width 0.3s; }
.prop-section { margin-bottom: 12px; }
.prop-section-title { font-size: 8px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; padding-bottom: 4px; border-bottom: 1px solid var(--border); }
.prop-row { display: flex; gap: 8px; padding: 3px 0; }
.prop-row-key { font-size: 9px; font-weight: 500; color: var(--text-muted); min-width: 60px; flex-shrink: 0; }
.prop-row-val { font-size: 10px; font-weight: 300; color: var(--text-dim); word-break: break-word; }
.prop-notes { font-size: 10px; font-weight: 300; color: var(--text-dim); line-height: 1.7; }
.prop-tags-wrap { display: flex; flex-wrap: wrap; gap: 4px; }
.prop-tag { font-size: 8px; font-weight: 500; padding: 1px 7px; border-radius: 2px; background: var(--accent-lo); color: var(--accent-hi); border: 1px solid var(--accent-bd); }
.prop-links-list { display: flex; flex-direction: column; gap: 3px; }
.prop-link-row { font-size: 9px; font-weight: 300; color: var(--text-dim); display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 2px 4px; border-radius: 3px; transition: background 0.1s; }
.prop-link-row:hover { background: rgba(215,215,215,0.05); color: var(--text); }
.prop-link-arrow { color: var(--accent); font-size: 10px; flex-shrink: 0; }
.prop-custom { }
.prop-custom-row { display: flex; gap: 8px; padding: 2px 0; font-size: 9px; }
.prop-custom-key { color: var(--text-muted); font-weight: 500; min-width: 70px; }
.prop-custom-val { color: var(--text-dim); font-weight: 300; word-break: break-word; }
.prop-edit-btn {
  display: block; width: 100%; margin-top: 14px;
  font-family: var(--font); font-size: 9px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase;
  padding: 7px; border: 1px solid var(--border-hi); border-radius: var(--radius);
  background: transparent; color: var(--text-dim); cursor: pointer; transition: all 0.12s; text-align: center;
}
.prop-edit-btn:hover { border-color: var(--accent-bd); color: var(--white); background: var(--accent-lo); }

/* INDEX TAB */
#ov-tab-index { overflow: hidden; display: flex; flex-direction: column; }
#overlay-index-header {
  padding: 8px 14px 5px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
}
.ov-col-labels { display: flex; gap: 8px; font-size: 7px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); }
#overlay-list { flex: 1; overflow-y: auto; padding: 2px 0; }
.overlay-row {
  display: flex; align-items: center; gap: 7px;
  padding: 5px 14px; transition: background 0.1s; cursor: pointer;
}
.overlay-row:hover { background: rgba(215,215,215,0.03); }
.overlay-row.selected { background: var(--accent-lo); }
.ov-rank { font-family: var(--font); font-size: 7px; font-weight: 300; color: rgba(215,215,215,0.15); min-width: 14px; text-align: right; flex-shrink: 0; }
.ov-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.ov-type {
  font-family: var(--font); font-size: 6px; font-weight: 700; letter-spacing: 0.3px;
  padding: 1px 4px; border-radius: 2px; flex-shrink: 0; text-transform: uppercase;
}
.ov-name { font-family: var(--font); font-size: 10px; font-weight: 300; color: var(--text-dim); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ov-imp { font-family: var(--font); font-size: 9px; font-weight: 700; color: var(--accent-hi); min-width: 20px; text-align: right; }
.ov-conn { font-family: var(--font); font-size: 9px; font-weight: 300; color: var(--text-muted); min-width: 16px; text-align: right; }

/* TAGS TAB */
#ov-tab-tags .ov-scroll { flex: 1; overflow-y: auto; padding: 14px; }
.ov-section-title { font-size: 8px; font-weight: 500; letter-spacing: 1.2px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
#tag-cloud { display: flex; flex-wrap: wrap; gap: 5px; }
.tag-cloud-item {
  font-family: var(--font); font-size: 9px; font-weight: 300; padding: 3px 9px; border-radius: 3px;
  border: 1px solid var(--border); background: transparent; color: var(--text-muted);
  cursor: pointer; transition: all 0.1s; display: flex; align-items: center; gap: 5px;
}
.tag-cloud-item:hover { border-color: var(--border-hi); color: var(--text-dim); }
.tag-cloud-item.active { background: var(--accent-lo); color: var(--accent-hi); border-color: var(--accent-bd); }
.tag-cloud-count { font-size: 7px; color: var(--text-muted); font-weight: 300; }
.tag-cloud-item.active .tag-cloud-count { color: var(--accent); }
.no-tags-hint { font-size: 10px; font-weight: 300; color: var(--text-muted); text-align: center; padding: 20px 0; }

/* STATS TAB */
#ov-tab-stats .ov-scroll { flex: 1; overflow-y: auto; padding: 14px; }
.stats-section { margin-bottom: 16px; }
.stats-title { font-size: 8px; font-weight: 500; letter-spacing: 1.2px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid var(--border); }
.stats-row { display: flex; justify-content: space-between; align-items: center; padding: 2px 0; font-size: 9px; }
.stats-row .sk { color: var(--text-muted); font-weight: 300; }
.stats-row .sv { color: var(--text-dim); font-weight: 500; }
.stats-row .sv.accent { color: var(--accent-hi); }
.stats-row .sv.red { color: var(--red); }
.stats-row .sv.green { color: var(--green); }
.type-dist-row { display: flex; align-items: center; gap: 6px; padding: 2px 0; font-size: 8px; }
.type-dist-name { min-width: 65px; color: var(--text-muted); font-weight: 300; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.type-dist-bar-wrap { flex: 1; background: rgba(255,255,255,0.05); border-radius: 1px; height: 3px; overflow: hidden; }
.type-dist-bar { height: 100%; border-radius: 1px; transition: width 0.4s; }
.type-dist-count { color: rgba(215,215,215,0.3); min-width: 16px; text-align: right; font-size: 7px; font-weight: 300; }
.stats-top-row { display: flex; justify-content: space-between; padding: 2px 0; font-size: 9px; cursor: pointer; border-radius: 3px; padding: 3px 4px; transition: background 0.1s; }
.stats-top-row:hover { background: rgba(215,215,215,0.04); }
.stats-top-name { color: var(--text-dim); font-weight: 300; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
.stats-top-val { color: var(--text-muted); font-size: 8px; flex-shrink: 0; }

/* Overlay toggle */
#btn-overlay-toggle {
  position: absolute; top: 50%; right: 0; transform: translateY(-50%);
  z-index: 41; width: 16px; height: 40px;
  background: rgba(0,0,0,0.9);
  border: 1px solid var(--border); border-right: none;
  border-radius: 4px 0 0 4px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; padding: 0; transition: all 0.15s;
}
#btn-overlay-toggle:hover { border-color: var(--accent-bd); background: rgba(34,3,255,0.08); }

/* ══ MODAL ════════════════════════════════════════════════ */
#modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.65); backdrop-filter: blur(8px);
  z-index: 1000; display: none; align-items: center; justify-content: center;
}
#modal-overlay.show { display: flex; }
#modal {
  background: var(--panel2); border: 1px solid var(--border-hi);
  border-top: 2px solid var(--accent); border-radius: 6px;
  box-shadow: 0 30px 80px rgba(0,0,0,0.9);
  width: 540px; max-width: 96vw; max-height: 90vh; overflow-y: auto;
  padding: 24px 26px; position: relative;
  animation: modalIn 0.2s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes modalIn {
  from { transform: scale(0.92) translateY(12px); opacity: 0; }
  to   { transform: scale(1) translateY(0); opacity: 1; }
}
#modal h2 { font-size: 13px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 20px; color: var(--white); }
#modal h2 .accent { color: var(--accent-hi); }
#modal-close {
  position: absolute; top: 13px; right: 13px;
  background: transparent; border: 1px solid var(--border); border-radius: 3px;
  width: 24px; height: 24px; font-size: 12px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; color: var(--text-muted); transition: all 0.12s;
}
#modal-close:hover { background: rgba(215,215,215,0.06); color: var(--text); border-color: var(--border-hi); }

/* Modal sections */
.modal-section { margin-bottom: 18px; }
.modal-section-title {
  font-size: 8px; font-weight: 700; letter-spacing: 1.4px; text-transform: uppercase;
  color: var(--text-muted); margin-bottom: 10px;
  display: flex; align-items: center; gap: 8px;
}
.modal-section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

/* Fields */
.field-group { margin-bottom: 10px; }
.field-group label { display: block; font-size: 8px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
.field-group input[type="text"],
.field-group input[type="number"],
.field-group textarea,
.field-group select {
  font-family: var(--font); font-size: 12px; font-weight: 300; width: 100%;
  padding: 7px 10px; border: 1px solid var(--border); border-radius: var(--radius);
  outline: none; background: rgba(0,0,0,0.5); transition: border 0.15s; color: var(--text);
}
.field-group input:focus, .field-group textarea:focus, .field-group select:focus {
  border-color: var(--accent-bd); background: rgba(34,3,255,0.04);
}
.field-group select {
  appearance: none; -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='6' viewBox='0 0 8 6'%3E%3Cpath d='M1 1l3 3 3-3' stroke='%23888' stroke-width='1.2' fill='none'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center; background-color: rgba(0,0,0,0.5);
  padding-right: 28px; cursor: pointer;
}
.row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

/* Importance slider — stylish */
.imp-slider-wrap { display: flex; flex-direction: column; gap: 5px; }
.imp-slider-row { display: flex; align-items: center; gap: 12px; }
.imp-slider-val { font-size: 22px; font-weight: 700; color: var(--white); min-width: 40px; text-align: right; line-height: 1; }
.imp-slider-track-wrap { flex: 1; position: relative; height: 20px; display: flex; align-items: center; }
input#m-importance {
  -webkit-appearance: none; appearance: none;
  width: 100%; height: 2px; background: transparent; border: none; outline: none; padding: 0;
  cursor: pointer; position: relative; z-index: 2;
}
input#m-importance::-webkit-slider-runnable-track {
  height: 2px; background: var(--border-hi); border-radius: 1px;
}
input#m-importance::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px; height: 14px; border-radius: 50%;
  background: var(--accent); border: 2px solid var(--white);
  margin-top: -6px; box-shadow: 0 0 8px rgba(34,3,255,0.6);
  transition: box-shadow 0.15s;
}
input#m-importance:hover::-webkit-slider-thumb { box-shadow: 0 0 14px rgba(34,3,255,0.9); }
input#m-importance::-moz-range-track { height: 2px; background: var(--border-hi); border-radius: 1px; }
input#m-importance::-moz-range-thumb {
  width: 14px; height: 14px; border-radius: 50%;
  background: var(--accent); border: 2px solid var(--white); box-shadow: 0 0 8px rgba(34,3,255,0.6);
}
.imp-labels { display: flex; justify-content: space-between; font-size: 7px; font-weight: 300; color: var(--text-muted); padding: 0 1px; }

/* Tag input (for tags, owners) */
.tag-input-wrap {
  border: 1px solid var(--border); border-radius: var(--radius);
  background: rgba(0,0,0,0.5); padding: 5px 7px;
  display: flex; flex-wrap: wrap; gap: 4px; align-items: center;
  min-height: 36px; cursor: text; transition: border 0.15s;
}
.tag-input-wrap:focus-within { border-color: var(--accent-bd); }
.tag-chip {
  font-family: var(--font); font-size: 9px; font-weight: 500;
  background: var(--accent-lo); color: var(--accent-hi); border: 1px solid var(--accent-bd);
  border-radius: 2px; padding: 1px 6px 1px 7px;
  display: flex; align-items: center; gap: 4px;
}
.tag-chip-rm { background: none; border: none; color: rgba(68,51,255,0.7); cursor: pointer; font-size: 10px; padding: 0; line-height: 1; }
.tag-chip-rm:hover { color: var(--red); }
.tag-chip-input {
  font-family: var(--font); font-size: 11px; font-weight: 300;
  background: transparent; border: none; outline: none; color: var(--text);
  flex: 1; min-width: 80px; padding: 1px 2px;
}
.tag-chip-input::placeholder { color: var(--text-muted); font-size: 10px; }

/* Type/status autocomplete input */
.autocomplete-wrap { position: relative; }
.ac-input {
  font-family: var(--font); font-size: 12px; font-weight: 300; width: 100%;
  padding: 7px 10px; border: 1px solid var(--border); border-radius: var(--radius);
  outline: none; background: rgba(0,0,0,0.5); color: var(--text); transition: border 0.15s;
}
.ac-input:focus { border-color: var(--accent-bd); }
.ac-suggestions {
  position: absolute; top: 100%; left: 0; right: 0; z-index: 200;
  background: var(--panel); border: 1px solid var(--border-hi);
  border-radius: 0 0 var(--radius) var(--radius);
  max-height: 160px; overflow-y: auto; display: none;
}
.ac-suggestions.show { display: block; }
.ac-option {
  padding: 6px 10px; font-size: 11px; font-weight: 300; color: var(--text-dim);
  cursor: pointer; transition: background 0.1s; display: flex; align-items: center; gap: 7px;
}
.ac-option:hover { background: rgba(215,215,215,0.05); color: var(--text); }
.ac-option .ac-type-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
.ac-new { color: var(--accent-hi); font-size: 10px; }

/* Link select */
.link-select {
  font-family: var(--font); font-size: 11px; font-weight: 300; width: 100%;
  min-height: 70px; padding: 5px; border: 1px solid var(--border);
  border-radius: var(--radius); background: rgba(0,0,0,0.5); color: var(--text); outline: none;
}
.link-select:focus { border-color: var(--accent-bd); }

/* Link rel labels */
#link-rels-wrap { margin-top: 6px; }
.link-rel-row { display: flex; align-items: center; gap: 7px; padding: 4px 0; border-bottom: 1px solid var(--border); font-size: 10px; font-weight: 300; }
.link-rel-row:last-child { border-bottom: none; }
.link-rel-arrow { color: var(--accent); flex-shrink: 0; font-size: 11px; }
.link-rel-name { color: var(--text-dim); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.link-rel-input {
  font-family: var(--font); font-size: 9px; font-weight: 300;
  padding: 2px 8px; border: 1px solid var(--border); border-radius: 3px;
  background: rgba(0,0,0,0.5); color: var(--accent-hi); outline: none; width: 120px; transition: border 0.12s;
}
.link-rel-input:focus { border-color: var(--accent-bd); }
.link-rel-input::placeholder { color: var(--text-muted); font-size: 8px; }

/* Custom props */
#custom-props-list { margin-top: 4px; }
.custom-prop-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
.custom-prop-row input { flex: 1; font-family: var(--font); font-size: 11px; font-weight: 300; padding: 5px 9px; border: 1px solid var(--border); border-radius: 4px; background: rgba(0,0,0,0.5); color: var(--text-dim); outline: none; transition: border 0.12s; }
.custom-prop-row input:focus { border-color: var(--accent-bd); }
.custom-prop-row .rm-prop { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 14px; padding: 0 3px; transition: color 0.12s; }
.custom-prop-row .rm-prop:hover { color: var(--red); }

/* Pin toggle */
.pin-toggle-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
.pin-toggle-row label { font-size: 10px; font-weight: 300; color: var(--text-dim); cursor: pointer; }
.pin-toggle-row input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; width: 13px; height: 13px; }

.modal-meta { font-size: 8px; font-weight: 300; color: var(--text-muted); margin-top: 4px; display: flex; gap: 14px; }
.modal-actions { display: flex; gap: 6px; margin-top: 20px; justify-content: flex-end; }
.modal-actions .left { margin-right: auto; display: flex; gap: 6px; }

/* ══ QUICK SWITCHER ═══════════════════════════════════════ */
#qs-overlay {
  position: fixed; inset: 0; z-index: 2000;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(10px);
  display: none; align-items: flex-start; justify-content: center; padding-top: 10vh;
}
#qs-overlay.show { display: flex; }
#qs-modal {
  background: var(--panel2); border: 1px solid var(--border-hi);
  border-top: 2px solid var(--accent); border-radius: 6px;
  box-shadow: 0 24px 64px rgba(0,0,0,0.9);
  width: 500px; max-width: 95vw; overflow: hidden;
  animation: modalIn 0.16s cubic-bezier(0.34,1.56,0.64,1);
}
#qs-header { padding: 12px 14px; display: flex; align-items: center; gap: 9px; border-bottom: 1px solid var(--border); }
#qs-header span { color: var(--text-muted); font-size: 14px; }
#qs-input { font-family: var(--font); font-size: 13px; font-weight: 300; background: transparent; border: none; outline: none; color: var(--text); flex: 1; }
#qs-input::placeholder { color: rgba(215,215,215,0.2); }
#qs-list { max-height: 320px; overflow-y: auto; }
.qs-row { display: flex; align-items: center; gap: 8px; padding: 8px 14px; cursor: pointer; transition: background 0.1s; border-bottom: 1px solid var(--border); }
.qs-row:last-child { border-bottom: none; }
.qs-row:hover, .qs-row.selected { background: var(--accent-lo); }
.qs-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.qs-type { font-size: 7px; font-weight: 700; padding: 1px 4px; border-radius: 2px; flex-shrink: 0; }
.qs-name { font-family: var(--font); font-size: 12px; font-weight: 300; color: var(--text-dim); flex: 1; }
.qs-name em { color: var(--accent-hi); font-style: normal; }
.qs-status { font-size: 8px; font-weight: 300; color: var(--text-muted); text-transform: uppercase; }
.qs-imp { font-size: 9px; font-weight: 700; color: var(--accent-hi); min-width: 18px; text-align: right; }
.qs-hint { padding: 9px 14px; font-size: 8px; color: rgba(215,215,215,0.15); text-align: center; letter-spacing: 0.8px; text-transform: uppercase; }
.qs-empty { padding: 20px 14px; font-size: 11px; font-weight: 300; color: var(--text-muted); text-align: center; }

/* ══ HELP ═════════════════════════════════════════════════ */
#help-overlay { position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.75); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; }
#help-overlay.show { display: flex; }
#help-modal { background: var(--panel2); border: 1px solid var(--border-hi); border-top: 2px solid var(--accent); border-radius: 6px; padding: 24px 26px; width: 380px; max-width: 95vw; box-shadow: 0 24px 64px rgba(0,0,0,0.9); animation: modalIn 0.16s cubic-bezier(0.34,1.56,0.64,1); }
#help-modal h3 { font-size: 11px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--white); margin-bottom: 14px; }
.kbd-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; font-weight: 300; border-bottom: 1px solid var(--border); }
.kbd-row:last-of-type { border-bottom: none; }
.kbd-row .keys { display: flex; gap: 4px; }
.kbd { font-family: var(--font); font-size: 8px; font-weight: 500; padding: 1px 6px; border-radius: 3px; background: var(--panel); border: 1px solid var(--border-hi); color: var(--accent-hi); letter-spacing: 0.3px; }
.kbd-desc { color: var(--text-muted); }

/* ══ SCROLLBAR ════════════════════════════════════════════ */
::-webkit-scrollbar { width: 3px; height: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-hi); border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: rgba(34,3,255,0.4); }

/* 3D toggle indicator */
#mode-indicator {
  position: absolute; top: 12px; right: 50px; z-index: 50;
  display: none; font-family: var(--font); font-size: 8px; font-weight: 500;
  letter-spacing: 1.5px; text-transform: uppercase; color: var(--accent);
  padding: 4px 10px; border: 1px solid var(--accent-bd); border-radius: 20px;
  background: rgba(0,0,0,0.8); backdrop-filter: blur(6px);
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse { 0%,100% { opacity: 0.6; } 50% { opacity: 1; } }
</style>
</head>
<body>

<!-- ═══ TOOLBAR ════════════════════════════════════════════ -->
<div id="toolbar">

  <!-- BRAND -->
  <div class="brand">
    <span class="brand-name"><em>ECO</em>.SYSTEM.OS</span>
  </div>

  <!-- GROUP: LAYOUT (empty placeholder for spacing) -->
  <div class="tb-group" style="padding:0 4px;"></div>

  <!-- GROUP: CREATE -->
  <div class="tb-group">
    <button class="btn primary" id="btn-add">+ Node</button>
  </div>

  <!-- GROUP: VISUALS + LINKS + RELAYOUT -->
  <div class="tb-group">
    <div class="drop-wrap" id="visuals-wrap">
      <button class="btn" id="btn-visuals">
        <svg width="12" height="12" viewBox="0 0 14 14" fill="none">
          <circle cx="7" cy="7" r="5.5" stroke="currentColor" stroke-width="1.3"/>
          <circle cx="7" cy="7" r="2" fill="currentColor"/>
        </svg>
        Visuals ▾
      </button>
      <div class="dropdown" id="visuals-panel">
        <div class="drop-header">Shape</div>
        <button class="drop-item" id="vi-shape-circle"><span class="di-check" id="vi-chk-circle">✓</span> Filled Circles</button>
        <button class="drop-item" id="vi-shape-outline"><span class="di-check" id="vi-chk-outline"> </span> Outline Circles</button>
        <button class="drop-item" id="vi-shape-rect"><span class="di-check" id="vi-chk-rect"> </span> Cards (Rect)</button>
        <div class="drop-sep"></div>
        <div class="drop-header">Color</div>
        <button class="drop-item" id="vi-color-type"><span class="di-check" id="vi-chk-ctype"> </span> Color by Type</button>
        <div class="drop-item" id="vi-bg-wrap" style="cursor:default;user-select:none;">
          <span style="font-size:9px;color:var(--text-muted);flex:1;">Canvas BG</span>
          <div style="position:relative;width:28px;height:16px;">
            <input type="color" id="bg-color-input" value="#050505" title="Canvas background"
              style="position:absolute;inset:0;opacity:0;width:100%;height:100%;cursor:pointer;border:none;padding:0;">
            <div id="bg-color-swatch" style="width:28px;height:16px;border-radius:2px;border:1px solid var(--border-hi);pointer-events:none;background:#050505;"></div>
          </div>
        </div>
        <div class="drop-sep"></div>
        <div class="drop-header">View Mode</div>
        <button class="drop-item" id="vi-3d"><span class="di-check" id="vi-chk-3d"> </span> 3D Force Graph</button>
        <button class="drop-item" id="vi-cluster"><span class="di-check" id="vi-chk-cluster"> </span> Type Clusters</button>
      </div>
    </div>
    <!-- Links button: pauses/resumes particle flow on links -->
    <button class="btn" id="btn-links-toggle" title="Pause / resume link animation">
      <svg width="11" height="11" viewBox="0 0 12 12" fill="none">
        <path d="M2 2h2.5v8H2zM7.5 2H10v8H7.5z" fill="currentColor" opacity="0.7"/>
      </svg>
      Links
    </button>
    <button class="btn" id="btn-reset-layout" title="Relayout graph">
      <svg width="12" height="12" viewBox="0 0 14 14" fill="none">
        <path d="M2 7a5 5 0 1 0 1.2-3.2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
        <polyline points="0.5,3.5 3.5,4 3,0.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Relayout
    </button>
    <button class="btn btn-icon" id="btn-toggle-filters" title="Toggle filters">
      <svg width="12" height="12" viewBox="0 0 14 14" fill="none">
        <path d="M1.5 3.5h11M3.5 7h7M5.5 10.5h3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
      </svg>
    </button>
  </div>

  <!-- SPACER -->
  <div style="flex:1;"></div>

  <!-- GROUP: FILE + SEARCH (far right) -->
  <div class="tb-group right" style="gap:5px;">
    <button class="btn" id="btn-import-json">Import</button>
    <div class="drop-wrap" id="save-wrap">
      <button class="btn primary" id="btn-save-menu">Save ▾</button>
      <div class="dropdown right-align" id="save-panel">
        <button class="drop-item" id="save-json">
          <svg width="11" height="11" viewBox="0 0 12 12" fill="none"><path d="M2 1h6l2 2v8H2V1z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/><path d="M4 9h4M4 7h2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>
          Save as JSON
        </button>
        <button class="drop-item" id="save-svg">
          <svg width="11" height="11" viewBox="0 0 12 12" fill="none"><rect x="1" y="2" width="10" height="8" rx="1" stroke="currentColor" stroke-width="1.2"/><path d="M4 7l2-3 2 3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="8" cy="4.5" r="1" fill="currentColor"/></svg>
          Save as SVG
        </button>
        <div class="drop-sep"></div>
        <button class="drop-item" id="save-ls">
          <svg width="11" height="11" viewBox="0 0 12 12" fill="none"><path d="M6 1v7M3 5l3 3 3-3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M1 10h10" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>
          Save to Browser
        </button>
        <button class="drop-item" id="load-ls">
          <svg width="11" height="11" viewBox="0 0 12 12" fill="none"><path d="M6 10V3M3 6l3-3 3 3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M1 10h10" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>
          Load from Browser
        </button>
      </div>
    </div>
    <input type="file" id="file-input" accept=".json" style="display:none">
    <div style="width:1px;height:20px;background:var(--border);margin:0 2px;flex-shrink:0;"></div>
    <div id="search-wrap">
      <input type="text" id="search" placeholder="Search nodes…  (Ctrl+K)">
    </div>
    <button class="btn btn-icon" id="btn-help" title="Help / keyboard shortcuts">?</button>
  </div>
</div>

<!-- ═══ FILTER BAR ═════════════════════════════════════════ -->
<div id="filter-bar" class="hidden">
  <span class="filter-label">Type:</span>
  <div id="type-chips"></div>
  <div class="fsep"></div>
  <span class="filter-label">Status:</span>
  <select id="filter-status-sel"><option value="">All</option></select>
  <div class="fsep"></div>
  <span class="filter-label">Tag:</span>
  <input type="text" id="filter-tag-input" placeholder="filter tag…">
  <div class="fsep"></div>
  <button class="fchip" id="btn-orphan-filter">◎ Orphans</button>
  <button id="btn-clear-filters" style="margin-left:4px">✕ Clear</button>
</div>

<!-- ═══ CANVAS ══════════════════════════════════════════════ -->
<div id="canvas-wrap">
  <div id="empty-hint">
    <div class="big-brand">ECO.SYSTEM.OS</div>
    <p>Your governance map is empty.<br>
    <strong>+ Node</strong> to begin — or <strong>Import</strong> a saved graph.<br>
    Press <strong>?</strong> for shortcuts.</p>
  </div>

  <div id="mode-indicator">3D MODE</div>
  <button id="btn-focus-exit">✕ Exit Focus — Esc</button>

  <!-- Overlay toggle -->
  <button id="btn-overlay-toggle" title="Toggle panel">
    <svg width="8" height="11" viewBox="0 0 9 13" fill="none">
      <path id="overlay-chevron" d="M6.5 1L1.5 6.5L6.5 12" stroke="rgba(215,215,215,0.3)" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <!-- OVERLAY PANEL -->
  <div id="overlay-panel">
    <div id="overlay-tabs">
      <button class="ov-tab-btn active" data-tab="properties">Props</button>
      <button class="ov-tab-btn" data-tab="index">Index</button>
      <button class="ov-tab-btn" data-tab="tags">Tags</button>
      <button class="ov-tab-btn" data-tab="stats">Stats</button>
    </div>

    <!-- PROPERTIES TAB -->
    <div class="ov-tab-content active" id="ov-tab-properties">
      <div id="prop-panel-empty">
        <div class="prop-empty-icon">◈</div>
        <p>Click any node to inspect its properties here.<br>Double-click to edit.</p>
      </div>
      <div id="prop-panel-content" style="display:none;" class="prop-content ov-scroll"></div>
    </div>

    <!-- INDEX TAB -->
    <div class="ov-tab-content" id="ov-tab-index">
      <div id="overlay-index-header">
        <span style="font-size:7px;font-weight:500;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);">Entry</span>
        <div class="ov-col-labels"><span>IMP</span><span>CNX</span></div>
      </div>
      <div id="overlay-list"></div>
    </div>

    <!-- TAGS TAB -->
    <div class="ov-tab-content" id="ov-tab-tags">
      <div class="ov-scroll" style="flex:1;overflow-y:auto;padding:14px;">
        <div class="ov-section-title">All Tags</div>
        <div id="tag-cloud"></div>
      </div>
    </div>

    <!-- STATS TAB -->
    <div class="ov-tab-content" id="ov-tab-stats">
      <div class="ov-scroll" style="flex:1;overflow-y:auto;padding:14px;" id="ov-stats-content"></div>
    </div>
  </div>

  <!-- Zoom fit (canvas) -->
  <button id="btn-zoom-fit" title="Zoom to fit">
    <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
      <path d="M1.5 5V1.5H5" stroke="#666" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M11 1.5H14.5V5" stroke="#666" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M14.5 11V14.5H11" stroke="#666" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M5 14.5H1.5V11" stroke="#666" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <!-- 3D container -->
  <div id="graph-3d"></div>

  <!-- 2D SVG -->
  <svg id="graph">
    <defs>
      <!-- per-link arrow markers are created dynamically in JS -->
      <defs id="dynamic-defs"></defs>
      <filter id="glow-base" x="-40%" y="-40%" width="180%" height="180%">
        <feGaussianBlur stdDeviation="3" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
      <filter id="glow-bright" x="-60%" y="-60%" width="220%" height="220%">
        <feGaussianBlur stdDeviation="8" result="blur"/>
        <feComponentTransfer in="blur" result="bright">
          <feFuncR type="linear" slope="1.6"/><feFuncG type="linear" slope="1.6"/><feFuncB type="linear" slope="1.6"/>
        </feComponentTransfer>
        <feMerge><feMergeNode in="bright"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <g id="zoom-layer">
      <g id="links-layer"></g>
      <g id="link-labels-layer"></g>
      <g id="particles-layer"></g>
      <g id="nodes-layer"></g>
    </g>
  </svg>
</div>

<!-- ═══ STATUS / FOOTER ══════════════════════════════════════ -->
<div id="statusbar">
  <div class="stat-item"><span class="stat-key">Nodes</span><span class="stat-val" id="stat-nodes">0</span></div>
  <div class="stat-item"><span class="stat-key">Links</span><span class="stat-val" id="stat-links">0</span></div>
  <div class="stat-item"><span class="stat-key">Orphans</span><span class="stat-val" id="stat-orphans">0</span></div>
  <div class="stat-item"><span class="stat-key">Density</span><span class="stat-val" id="stat-density">—</span></div>
  <span id="focus-indicator">◉ FOCUS MODE</span>
  <span class="stat-accent">Ctrl+K quick search · F focus · ? help</span>
</div>
<div id="footer">
  <span class="footer-left">ECO.SYSTEM.OS Governance Mapper — For personal use only.</span>
  <span>© Constantinos Tolias 2026. All rights reserved.</span>
  <span class="footer-version">v1.032</span>
</div>

<div id="tooltip"></div>
<div id="notif"></div>

<!-- ═══ MODAL ════════════════════════════════════════════════ -->
<div id="modal-overlay">
<div id="modal">
  <button id="modal-close">✕</button>
  <h2 id="modal-title">Add <span class="accent">Node</span></h2>

  <!-- IDENTITY -->
  <div class="modal-section">
    <div class="modal-section-title">Identity</div>
    <div class="field-group"><label>Name *</label>
      <input type="text" id="m-name" placeholder="Node name…" maxlength="40">
    </div>
    <div class="row2">
      <div class="field-group"><label>Type</label>
        <div class="autocomplete-wrap">
          <input type="text" class="ac-input" id="m-type" placeholder="Select or add type…" autocomplete="off">
          <div class="ac-suggestions" id="m-type-suggestions"></div>
        </div>
      </div>
      <div class="field-group"><label>Status</label>
        <div class="autocomplete-wrap">
          <input type="text" class="ac-input" id="m-status" placeholder="Select or add status…" autocomplete="off">
          <div class="ac-suggestions" id="m-status-suggestions"></div>
        </div>
      </div>
    </div>
    <div class="field-group"><label>Owner / Responsible Parties</label>
      <div class="tag-input-wrap" id="owner-wrap">
        <div id="m-owner-chips"></div>
        <input type="text" class="tag-chip-input" id="m-owner-input" placeholder="Add owner, press Enter…">
      </div>
    </div>
    <div class="field-group"><label>Importance (0 – 100)</label>
      <div class="imp-slider-wrap">
        <div class="imp-slider-row">
          <div class="imp-slider-track-wrap">
            <input type="range" id="m-importance" min="0" max="100" value="50">
          </div>
          <span class="imp-slider-val" id="m-importance-val">50</span>
        </div>
        <div class="imp-labels"><span>0</span><span>25</span><span>50</span><span>75</span><span>100</span></div>
      </div>
    </div>
  </div>

  <!-- APPEARANCE -->
  <div class="modal-section">
    <div class="modal-section-title">Appearance</div>
    <div class="field-group"><label>Node Colour</label>
      <div style="display:flex;align-items:center;gap:8px;">
        <input type="color" id="m-color" value="#2203ff" style="width:42px;height:32px;border-radius:4px;border:1px solid var(--border);padding:2px;cursor:pointer;background:#1c1c1c;">
        <div class="color-presets" id="color-presets" style="display:flex;gap:4px;flex-wrap:nowrap;"></div>
      </div>
    </div>
  </div>

  <!-- TAGS -->
  <div class="modal-section">
    <div class="modal-section-title">Tags</div>
    <div class="tag-input-wrap" id="tag-wrap">
      <div id="m-tag-chips"></div>
      <input type="text" class="tag-chip-input" id="m-tag-input" placeholder="Type tag, Enter or comma to add…">
    </div>
  </div>

  <!-- RELATIONSHIPS -->
  <div class="modal-section">
    <div class="modal-section-title">Relationships</div>
    <div class="field-group">
      <label>Outgoing Links → (this node points TO)</label>
      <select id="m-links-out" class="link-select" multiple></select>
      <small style="color:var(--text-muted);font-size:9px;font-weight:300;margin-top:3px;display:block">Hold Ctrl/Cmd to select multiple</small>
    </div>
    <div id="link-rels-wrap" style="display:none;margin-bottom:6px;">
      <label style="font-size:8px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:5px;">Relationship Labels</label>
      <div id="link-rels-list"></div>
    </div>
    <div class="field-group">
      <label>Incoming Links ← (nodes that point TO this)</label>
      <select id="m-links-in" class="link-select" multiple></select>
    </div>
  </div>

  <!-- NOTES -->
  <div class="modal-section">
    <div class="modal-section-title">Notes</div>
    <div class="field-group">
      <textarea id="m-notes" rows="3" placeholder="Description, context, decisions, rationale…"
        style="font-family:var(--font);font-size:12px;font-weight:300;width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius);outline:none;background:rgba(0,0,0,0.5);color:var(--text-dim);resize:vertical;transition:border 0.15s;"
        onfocus="this.style.borderColor='rgba(34,3,255,0.5)'" onblur="this.style.borderColor='rgba(215,215,215,0.08)'"></textarea>
    </div>
  </div>

  <!-- CUSTOM PROPS -->
  <div class="modal-section">
    <div class="modal-section-title">Custom Properties</div>
    <div id="custom-props-list"></div>
    <button class="btn" id="btn-add-prop" style="margin-top:5px;font-size:9px;height:24px;">+ Property</button>
  </div>

  <!-- OPTIONS -->
  <div class="modal-section">
    <div class="modal-section-title">Options</div>
    <div class="pin-toggle-row">
      <input type="checkbox" id="m-pinned">
      <label for="m-pinned">Pin position — lock this node in place</label>
    </div>
    <div class="modal-meta" id="modal-meta"></div>
  </div>

  <div class="modal-actions">
    <div class="left">
      <button class="btn danger" id="btn-delete-node">Delete</button>
      <button class="btn" id="btn-undo-del" style="display:none">↩ Undo</button>
    </div>
    <button class="btn" id="btn-cancel">Cancel</button>
    <button class="btn primary" id="btn-save-node">Save Node</button>
  </div>
</div>
</div>

<!-- ═══ QUICK SWITCHER ════════════════════════════════════════ -->
<div id="qs-overlay">
  <div id="qs-modal">
    <div id="qs-header"><span>⌕</span><input type="text" id="qs-input" placeholder="Search nodes…"></div>
    <div id="qs-list"></div>
    <div class="qs-hint">↑ ↓ navigate · Enter open · Esc close</div>
  </div>
</div>

<!-- ═══ HELP ══════════════════════════════════════════════════ -->
<div id="help-overlay">
  <div id="help-modal">
    <h3>Keyboard Shortcuts</h3>
    <div class="kbd-row"><div class="keys"><span class="kbd">Ctrl</span><span class="kbd">K</span></div><span class="kbd-desc">Quick node switcher</span></div>
    <div class="kbd-row"><div class="keys"><span class="kbd">F</span></div><span class="kbd-desc">Focus mode on hovered node</span></div>
    <div class="kbd-row"><div class="keys"><span class="kbd">Esc</span></div><span class="kbd-desc">Close modal / exit focus / close help</span></div>
    <div class="kbd-row"><div class="keys"><span class="kbd">Ctrl</span><span class="kbd">Z</span></div><span class="kbd-desc">Undo last node deletion</span></div>
    <div class="kbd-row"><div class="keys"><span class="kbd">?</span></div><span class="kbd-desc">Toggle this help panel</span></div>
    <div class="kbd-row"><div class="keys"><span class="kbd">Dbl-click</span></div><span class="kbd-desc">Edit node</span></div>
    <div class="kbd-row"><div class="keys"><span class="kbd">Click</span></div><span class="kbd-desc">Select node / show properties</span></div>
    <div class="kbd-row"><div class="keys"><span class="kbd">Right-click</span></div><span class="kbd-desc">Edit node</span></div>
    <div class="kbd-row"><div class="keys"><span class="kbd">Drag</span></div><span class="kbd-desc">Reposition node</span></div>
    <button class="btn" onclick="closeHelp()" style="margin-top:14px;width:100%;justify-content:center;height:32px;">Close</button>
  </div>
</div>

<!-- ═══ SCRIPT ════════════════════════════════════════════════ -->
<script>
// ════════════════════════════════════════════════════════════
//  ECO.SYSTEM.OS — Governance Network Mapper  v1.032
// ════════════════════════════════════════════════════════════

// ── Constants ─────────────────────────────────────────────
const PASTEL_PRESETS = [
  '#2203ff','#4433ff','#0066ff','#0099ff',
  '#00c8ff','#00c87a','#c8ff00','#ff6600',
  '#ff3b3b','#c800ff','#ffffff','#d7d7d7'
];

const DEFAULT_TYPES = ['Policy','Standard','Regulation','Process','Role','System','Risk','Control','Asset','Objective'];
const DEFAULT_STATUSES = ['Active','Draft','Under Review','Deprecated','Proposed','Archived'];

let customTypes = [];
let customStatuses = [];

const TYPE_COLORS = {
  'Policy':     '#4433ff','Standard':   '#00c87a','Regulation': '#ff6600',
  'Process':    '#9966ff','Role':        '#ffcc00','System':     '#00c8ff',
  'Risk':       '#ff3b3b','Control':     '#66ffaa','Asset':      '#cc99ff',
  'Objective':  '#2203ff',
};

const STATUS_COLORS = {
  'Active':       '#00c87a','Draft':         '#ffcc00','Under Review':  '#00c8ff',
  'Deprecated':   '#ff3b3b','Proposed':      '#9966ff','Archived':      '#888888',
};

const STORAGE_KEY = 'ecosystemos_gov_v1';

// ── State ──────────────────────────────────────────────────
let nodes = [];
let links = [];
let simulation, svg2D, g, linkLayer, linkLabelLayer, particleLayer, nodeLayer;
let hoveredNodeId = null;
let selectedNodeId = null;
const particleState = new Map();
let editingNodeId = null;
let nodeShape = 'circle';
let overlayVisible = true;
let activeOverlayTab = 'properties';
let zoomTransform = d3.zoomIdentity;
let zoomBehavior;
let colorByType = false;
let showLinkLabels = false;
let filterTypes = new Set();
let filterStatus = '';
let filterTagText = '';
let filterOrphans = false;
let focusNodeId = null;
let lastDeleted = null;
let qsSelectedIndex = -1;
let filterBarVisible = false;
let is3D = false;
let isCluster = false;
let graph3D = null;
let currentOwners = [];
let currentTags = [];
let linksAnimating = true; // false = particles frozen

// ── Helpers ────────────────────────────────────────────────
const uid = () => 'n' + Math.random().toString(36).substr(2, 8);
const now = () => new Date().toISOString();

// Importance: 0-100 mapped to radius 8-58
const nodeRadius = imp => 8 + (imp / 100) * 50;
const nodeHalfW  = imp => nodeRadius(imp) * 1.45;
const nodeHalfH  = imp => nodeRadius(imp) * 0.85;

function getNodeColor(node) {
  if (!node) return '#2203ff';
  if (colorByType && node.type) return TYPE_COLORS[node.type] || '#4433ff';
  return node.color || '#2203ff';
}

function allTypes() { return [...new Set([...DEFAULT_TYPES, ...customTypes])]; }
function allStatuses() { return [...new Set([...DEFAULT_STATUSES, ...customStatuses])]; }

function nodePassesFilters(node) {
  if (filterOrphans) return (!node.linksOut?.length) && (!node.linksIn?.length);
  if (filterTypes.size > 0 && !filterTypes.has(node.type || '')) return false;
  if (filterStatus && node.status !== filterStatus) return false;
  if (filterTagText) {
    const q = filterTagText.toLowerCase();
    if (!(node.tags || []).some(t => t.toLowerCase().includes(q))) return false;
  }
  return true;
}

function rectEdgeOffset(imp, dx, dy) {
  const hw = nodeHalfW(imp), hh = nodeHalfH(imp);
  const adx = Math.abs(dx), ady = Math.abs(dy);
  return (adx * hh > ady * hw) ? hw / adx : hh / ady;
}

const notify = (msg, dur = 2200) => {
  const el = document.getElementById('notif');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), dur);
};

// ── Data ───────────────────────────────────────────────────
function rebuildLinks() {
  links = [];
  nodes.forEach(n => {
    (n.linksOut || []).forEach(tid => {
      if (nodes.find(x => x.id === tid)) links.push({ source: n.id, target: tid });
    });
  });
  nodes.forEach(n => { n.linksIn = []; });
  links.forEach(l => {
    const t = nodes.find(x => x.id === (typeof l.target === 'object' ? l.target.id : l.target));
    const sid = typeof l.source === 'object' ? l.source.id : l.source;
    if (t && !t.linksIn.includes(sid)) t.linksIn.push(sid);
  });
}

// ── Init Graph ─────────────────────────────────────────────
function initGraph() {
  svg2D = d3.select('#graph');
  g = d3.select('#zoom-layer');
  linkLayer = d3.select('#links-layer');
  linkLabelLayer = d3.select('#link-labels-layer');
  particleLayer = d3.select('#particles-layer');
  nodeLayer = d3.select('#nodes-layer');

  zoomBehavior = d3.zoom().scaleExtent([0.05, 5])
    .on('zoom', e => { zoomTransform = e.transform; g.attr('transform', e.transform); });
  svg2D.call(zoomBehavior);

  const W = svg2D.node().clientWidth, H = svg2D.node().clientHeight;
  svg2D.call(zoomBehavior.transform, d3.zoomIdentity.translate(W/2, H/2));

  simulation = d3.forceSimulation()
    .force('link', d3.forceLink().id(d => d.id).distance(d => {
      const s = nodes.find(n => n.id === (typeof d.source==='object'?d.source.id:d.source));
      const t = nodes.find(n => n.id === (typeof d.target==='object'?d.target.id:d.target));
      const mi = s && t ? Math.min(s.importance, t.importance) : 50;
      return 60 + mi * 0.8;
    }).strength(0.4))
    .force('charge', d3.forceManyBody().strength(d => -150 - d.importance * 1.5))
    .force('collision', d3.forceCollide().radius(d => nodeRadius(d.importance) + 16).strength(0.85))
    .force('center', d3.forceCenter(0, 0))
    .on('tick', ticked);
}

// ── linkCoords ─────────────────────────────────────────────
function linkCoords(d) {
  const sx = d.source.x, sy = d.source.y, tx = d.target.x, ty = d.target.y;
  const dx = tx-sx, dy = ty-sy, dist = Math.sqrt(dx*dx+dy*dy)||1;
  const ndx = dx/dist, ndy = dy/dist;
  let startX, startY, endX, endY;
  if (nodeShape === 'rect') {
    startX = sx + ndx * rectEdgeOffset(d.source.importance||50, ndx, ndy);
    startY = sy + ndy * rectEdgeOffset(d.source.importance||50, ndx, ndy);
    const te = rectEdgeOffset(d.target.importance||50, ndx, ndy);
    endX = tx - ndx*(te+8); endY = ty - ndy*(te+8);
  } else {
    const sr = nodeRadius(d.source.importance||50), tr = nodeRadius(d.target.importance||50);
    startX = sx+ndx*sr; startY = sy+ndy*sr;
    endX = tx-ndx*(tr+8); endY = ty-ndy*(tr+8);
  }
  return {startX,startY,endX,endY};
}

// ── ticked ─────────────────────────────────────────────────
function ticked() {
  // Link paths
  linkLayer.selectAll('.link-path').attr('d', d => {
    const {startX,startY,endX,endY} = linkCoords(d);
    return `M${startX},${startY} L${endX},${endY}`;
  });

  // Link labels
  if (showLinkLabels) {
    const labelData = [];
    links.forEach(d => {
      const sid = typeof d.source==='object'?d.source.id:d.source;
      const tid = typeof d.target==='object'?d.target.id:d.target;
      const sNode = nodes.find(n=>n.id===sid);
      const tNode = nodes.find(n=>n.id===tid);
      // Show custom label OR target type as default fallback
      let labelText = '';
      if (sNode?.linkMeta?.[tid]?.label) labelText = sNode.linkMeta[tid].label;
      else if (tNode?.type) labelText = tNode.type;
      else labelText = '→';
      const {startX,startY,endX,endY} = linkCoords(d);
      labelData.push({ x:(startX+endX)/2, y:(startY+endY)/2, label: labelText, key: sid+'->'+tid });
    });
    const lbSel = linkLabelLayer.selectAll('.ll-group').data(labelData, d=>d.key);
    const lbEnter = lbSel.enter().append('g').attr('class','ll-group');
    lbEnter.append('rect').attr('class','link-label-bg').attr('rx',2);
    lbEnter.append('text').attr('class','link-label-text');
    const lbAll = lbEnter.merge(lbSel);
    lbAll.attr('transform', d=>`translate(${d.x},${d.y})`);
    lbAll.select('.link-label-text').text(d=>d.label);
    lbAll.each(function() {
      const textEl = this.querySelector('.link-label-text');
      if (!textEl) return;
      const bb = textEl.getBBox ? textEl.getBBox() : {x:-15,y:-5,width:30,height:10};
      const pad = 3;
      const rect = this.querySelector('.link-label-bg');
      if (rect) {
        rect.setAttribute('x', bb.x - pad);
        rect.setAttribute('y', bb.y - pad);
        rect.setAttribute('width', Math.max(bb.width + pad*2, 10));
        rect.setAttribute('height', bb.height + pad*2);
      }
    });
    lbSel.exit().remove();
  } else {
    linkLabelLayer.selectAll('.ll-group').remove();
  }

  // Particles
  links.forEach(d => {
    const sid = typeof d.source==='object'?d.source.id:d.source;
    const tid = typeof d.target==='object'?d.target.id:d.target;
    const key = sid+'->'+tid;
    if (!particleState.has(key)) {
      const sN = nodes.find(n=>n.id===sid);
      const speed = 0.003 + (sN?(sN.importance/100)*0.004:0);
      particleState.set(key,[{t:0,speed},{t:0.5,speed}]);
    }
    particleState.get(key).forEach(p=>{
      if(linksAnimating){p.t+=p.speed; if(p.t>1)p.t-=1;}
    });
  });
  const activeKeys = new Set(links.map(d=>{
    const sid=typeof d.source==='object'?d.source.id:d.source;
    const tid=typeof d.target==='object'?d.target.id:d.target;
    return sid+'->'+tid;
  }));
  for (const k of particleState.keys()) if (!activeKeys.has(k)) particleState.delete(k);

  const allParticles=[];
  links.forEach(d=>{
    const sid=typeof d.source==='object'?d.source.id:d.source;
    const tid=typeof d.target==='object'?d.target.id:d.target;
    const key=sid+'->'+tid; const ps=particleState.get(key); if(!ps)return;
    const {startX,startY,endX,endY}=linkCoords(d);
    const sN=nodes.find(n=>n.id===sid);
    const color=getNodeColor(sN||{color:'#2203ff'});
    ps.forEach(p=>allParticles.push({x:startX+(endX-startX)*p.t,y:startY+(endY-startY)*p.t,r:2,color,key}));
  });
  const pSel=particleLayer.selectAll('.particle').data(allParticles,(_,i)=>i);
  pSel.enter().append('circle').attr('class','particle')
    .merge(pSel)
    .attr('cx',d=>d.x).attr('cy',d=>d.y).attr('r',d=>d.r)
    .attr('fill',d=>d.color).attr('opacity',0.75).attr('pointer-events','none');
  pSel.exit().remove();

  // Node positions
  nodeLayer.selectAll('.node-group').attr('transform',d=>`translate(${d.x},${d.y})`);

  // Refresh cluster label positions
  if(clusterForceActive) {
    const centroids = getClusterCentroids();
    g.select('#cluster-labels-layer').selectAll('g').attr('transform', function() {
      // keep static — centroids don't move, only nodes do
    });
  }

  // Highlight logic
  const rootId = focusNodeId || hoveredNodeId;
  if (rootId) {
    const neighborIds = new Set([rootId]);
    const depth = focusNodeId ? 2 : 1;
    const expand = (id, d) => {
      if (d<=0) return;
      links.forEach(lk => {
        const sid=typeof lk.source==='object'?lk.source.id:lk.source;
        const tid=typeof lk.target==='object'?lk.target.id:lk.target;
        if (sid===id && !neighborIds.has(tid)){neighborIds.add(tid);expand(tid,d-1);}
        if (tid===id && !neighborIds.has(sid)){neighborIds.add(sid);expand(sid,d-1);}
      });
    };
    expand(rootId, depth);
    nodeLayer.selectAll('.node-group').each(function(d){
      const hl=neighborIds.has(d.id);
      d3.select(this).classed('highlighted',hl).classed('dimmed',!hl);
    });
    linkLayer.selectAll('.link-path').each(function(d){
      const sid=typeof d.source==='object'?d.source.id:d.source;
      const tid=typeof d.target==='object'?d.target.id:d.target;
      const conn=sid===rootId||tid===rootId;
      d3.select(this).attr('stroke-opacity',conn?0.9:0.03).attr('stroke-width',conn?1.8:1);
    });
    particleLayer.selectAll('.particle').attr('opacity',p=>{
      const[s,t]=(p.key||'').split('->');
      return (neighborIds.has(s)||neighborIds.has(t))?0.9:0.03;
    });
  } else {
    nodeLayer.selectAll('.node-group').each(function(d){
      const pass = nodePassesFilters(d);
      d3.select(this).classed('highlighted',false).classed('dimmed',!pass);
    });
    linkLayer.selectAll('.link-path').each(function(d){
      const sid=typeof d.source==='object'?d.source.id:d.source;
      const tid=typeof d.target==='object'?d.target.id:d.target;
      const sn=nodes.find(n=>n.id===sid),tn=nodes.find(n=>n.id===tid);
      const pass=sn&&tn&&nodePassesFilters(sn)&&nodePassesFilters(tn);
      d3.select(this).attr('stroke-opacity',pass?0.28:0.04).attr('stroke-width',1);
    });
    particleLayer.selectAll('.particle').attr('opacity',p=>{
      const[s]=((p.key||'').split('->'));
      const sn=nodes.find(n=>n.id===s);
      return (sn&&nodePassesFilters(sn))?0.75:0.04;
    });
  }
}

// ── updateGraph ────────────────────────────────────────────
function updateGraph(animate=false) {
  rebuildLinks(); updateStatus(); updateEmptyHint(); autoSave(); buildTypeChips(); buildStatusFilter();
  if (is3D) { refresh3D(); return; }

  const linkData = linkLayer.selectAll('.link-path').data(links, d=>{
    const sid=typeof d.source==='object'?d.source.id:d.source;
    const tid=typeof d.target==='object'?d.target.id:d.target;
    return sid+'->'+tid;
  });
  linkData.join(
    enter=>enter.append('path').attr('class','link-path').style('opacity',0)
      .call(el=>{updateLinkStyle(el); el.transition().duration(450).style('opacity',1);}),
    update=>update.call(updateLinkStyle),
    exit=>exit.transition().duration(280).style('opacity',0).remove()
  );

  const nodeData = nodeLayer.selectAll('.node-group').data(nodes, d=>d.id);
  nodeData.join(
    enter=>{
      const grp=enter.append('g').attr('class','node-group')
        .attr('transform',d=>`translate(${d.x||0},${d.y||0})`)
        .call(d3.drag().on('start',dragStart).on('drag',dragged).on('end',dragEnd))
        .on('click',(e,d)=>{e.stopPropagation(); if(e.detail===1){setTimeout(()=>{if(e.detail===1)selectNode(d.id);},200);}})
        .on('dblclick',(e,d)=>{e.preventDefault();e.stopPropagation();openModal(d.id);})
        .on('contextmenu',(e,d)=>{e.preventDefault();openModal(d.id);})
        .on('mouseenter',(e,d)=>{hoveredNodeId=d.id;showTooltip(e,d);})
        .on('mousemove',moveTooltip)
        .on('mouseleave',()=>{hoveredNodeId=null;hideTooltip();});
      grp.append('circle').attr('class','node-circle').attr('r',0)
        .transition().duration(600).ease(d3.easeElastic.period(0.5))
        .attr('r',d=>nodeRadius(d.importance));
      grp.append('text').attr('class','node-label').style('opacity',0)
        .transition().duration(400).style('opacity',1);
      updateNodeStyle(grp); updateNodeLabels(grp);
      return grp;
    },
    update=>{
      update.select('.node-circle').transition().duration(400).ease(d3.easeElastic.period(0.6))
        .attr('r',d=>nodeRadius(d.importance));
      updateNodeStyle(update); updateNodeLabels(update);
      return update;
    },
    exit=>exit.select('.node-circle').transition().duration(280).ease(d3.easeBackIn.overshoot(1.5))
      .attr('r',0).selection().transition().duration(0).remove()
  );

  // Pin rings & selection rings
  nodeLayer.selectAll('.node-group').each(function(d){
    const grp=d3.select(this);
    grp.select('.pin-ring').remove();
    grp.classed('selected-node', d.id===selectedNodeId);
    if (d.pinned){
      const r2=nodeRadius(d.importance)+5;
      if(nodeShape==='rect'){
        const hw=nodeHalfW(d.importance)+4,hh=nodeHalfH(d.importance)+4;
        grp.insert('rect','text').attr('class','pin-ring')
          .attr('x',-hw).attr('y',-hh).attr('width',hw*2).attr('height',hh*2).attr('rx',7);
      } else {
        grp.insert('circle','text').attr('class','pin-ring').attr('r',r2);
      }
    }
    if(d.pinned){d.fx=d.x;d.fy=d.y;}
    else if(!d._dragging){d.fx=null;d.fy=null;}
  });

  simulation.nodes(nodes);
  simulation.force('link').links(links);
  simulation.alpha(animate?0.8:0.3).restart();
}

// ── Font & Labels ──────────────────────────────────────────
function computeFontCaps() {
  const caps={};
  for(let imp=0;imp<=100;imp+=10){
    const r=nodeRadius(imp),usableW=r*1.44;
    for(let fs=14;fs>=7;fs--){
      if(Math.floor(usableW/(fs*0.58))>=3){caps[imp]=fs;break;}
    }
    if(!caps[imp])caps[imp]=7;
  }
  return caps;
}

function getImpTier(imp) {
  return Math.round(imp/10)*10;
}

function updateNodeLabels(sel) {
  const fontCaps=computeFontCaps();
  sel.each(function(d){
    const r=nodeRadius(d.importance);
    const textEl=d3.select(this).select('text.node-label').node();
    if(!textEl)return;
    while(textEl.firstChild)textEl.removeChild(textEl.firstChild);
    textEl.setAttribute('font-family',"'Sunflower','Helvetica Neue',sans-serif");
    textEl.setAttribute('fill','#ffffff');
    textEl.setAttribute('font-weight','500');
    const words=d.name.split(' '),maxLines=4;
    const tier=getImpTier(d.importance);
    const ceiling=fontCaps[tier]||fontCaps[Math.min(100,Math.max(0,tier))]||7;
    let fontSize=ceiling,lines=[];
    for(fontSize=ceiling;fontSize>=7;fontSize--){
      const charW=fontSize*0.58;
      const usableW=nodeShape==='rect'?nodeHalfW(d.importance)*1.8:r*1.44;
      const maxCPL=Math.max(3,Math.floor(usableW/charW));
      lines=[];let cur='',fits=true;
      for(const word of words){
        if(word.length>maxCPL){fits=false;break;}
        const test=cur?cur+' '+word:word;
        if(test.length<=maxCPL){cur=test;}else{lines.push(cur);cur=word;}
      }
      if(!fits)continue;
      if(cur)lines.push(cur);
      if(lines.length<=maxLines)break;
    }
    if(!lines.length)lines=[d.name];
    fontSize=Math.max(7,fontSize);
    textEl.setAttribute('font-size',fontSize);
    const lh=fontSize*1.3,startDy=-((lines.length-1)*lh)/2;
    lines.forEach((line,i)=>{
      const ts=document.createElementNS('http://www.w3.org/2000/svg','tspan');
      ts.setAttribute('x','0'); ts.setAttribute('dy',i===0?`${startDy}px`:`${lh}px`);
      ts.textContent=line; textEl.appendChild(ts);
    });
  });
}

// ── Node / Link style ─────────────────────────────────────
function updateNodeStyle(sel) {
  sel.select('.node-circle')
    .attr('fill',d=>nodeShape==='outline'?'rgba(255,255,255,0.04)':getNodeColor(d))
    .attr('stroke',d=>getNodeColor(d))
    .attr('stroke-width',d=>nodeShape==='outline'?1.8+d.importance*0.012:1.2+d.importance*0.01)
    .attr('filter','url(#glow-base)');
  if(nodeShape==='rect'){
    sel.select('.node-circle')
      .attr('x',d=>-nodeHalfW(d.importance)).attr('y',d=>-nodeHalfH(d.importance))
      .attr('width',d=>nodeHalfW(d.importance)*2).attr('height',d=>nodeHalfH(d.importance)*2)
      .attr('rx',4).attr('ry',4);
  }
}

function getOrCreateArrowMarker(color) {
  const safeId = 'arrow-' + color.replace('#','').replace(/[^a-zA-Z0-9]/g,'');
  const defs = document.getElementById('dynamic-defs');
  if (!defs.querySelector('#'+safeId)) {
    const marker = document.createElementNS('http://www.w3.org/2000/svg','marker');
    marker.setAttribute('id', safeId);
    marker.setAttribute('markerWidth','7'); marker.setAttribute('markerHeight','7');
    marker.setAttribute('refX','5'); marker.setAttribute('refY','3.5');
    marker.setAttribute('orient','auto'); marker.setAttribute('markerUnits','userSpaceOnUse');
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d','M0,0.5 L0,6.5 L7,3.5 z');
    path.setAttribute('fill', color); path.setAttribute('opacity','0.75');
    marker.appendChild(path); defs.appendChild(marker);
  }
  return 'url(#'+safeId+')';
}

function updateLinkStyle(sel) {
  sel.each(function(d) {
    const sid = typeof d.source==='object' ? d.source.id : d.source;
    const sN = nodes.find(n=>n.id===sid);
    const color = sN ? getNodeColor(sN) : '#2203ff';
    const markerId = getOrCreateArrowMarker(color);
    d3.select(this)
      .attr('stroke', color)
      .attr('stroke-width', 1)
      .attr('stroke-opacity', 0.28)
      .attr('marker-end', markerId);
  });
}

// ── Shape Morphing ─────────────────────────────────────────
function applyNodeShape(shape) {
  nodeShape=shape;
  nodeLayer.selectAll('.node-group').each(function(d){
    const grp=d3.select(this);
    grp.select('.node-circle').remove();
    grp.select('.pin-ring').remove();
    const r=nodeRadius(d.importance),hw=nodeHalfW(d.importance),hh=nodeHalfH(d.importance);
    let shapeEl;
    if(shape==='rect'){
      shapeEl=grp.insert('rect','text').attr('class','node-circle')
        .attr('x',-hw).attr('y',-hh).attr('width',hw*2).attr('height',hh*2)
        .attr('rx',4).attr('ry',4).style('opacity',0);
      shapeEl.transition().duration(380).ease(d3.easeCubicOut).style('opacity',1)
        .attr('x',-hw).attr('y',-hh).attr('width',hw*2).attr('height',hh*2);
    } else {
      shapeEl=grp.insert('circle','text').attr('class','node-circle').attr('r',0).style('opacity',0);
      shapeEl.transition().duration(420).ease(d3.easeElastic.period(0.55)).style('opacity',1).attr('r',r);
    }
    if(shape==='outline'){
      shapeEl.attr('fill','rgba(255,255,255,0.04)').attr('stroke',getNodeColor(d)).attr('stroke-width',1.8+d.importance*0.012);
    } else {
      shapeEl.attr('fill',getNodeColor(d)).attr('stroke',d3.color(getNodeColor(d)).brighter(0.3)).attr('stroke-width',1.2+d.importance*0.01);
    }
    shapeEl.attr('filter','url(#glow-base)');
    if(d.pinned){
      (shape==='rect'
        ? grp.insert('rect','text').attr('x',-hw-4).attr('y',-hh-4).attr('width',(hw+4)*2).attr('height',(hh+4)*2).attr('rx',7)
        : grp.insert('circle','text').attr('r',r+5)
      ).attr('class','pin-ring');
    }
  });
  updateNodeLabels(nodeLayer.selectAll('.node-group'));
  simulation.force('collision',d3.forceCollide().radius(d=>(shape==='rect'
    ?Math.sqrt(nodeHalfW(d.importance)**2+nodeHalfH(d.importance)**2)
    :nodeRadius(d.importance))+12).strength(0.85));
  simulation.alpha(0.15).restart();
  // Update checks in visuals dropdown
  ['circle','outline','rect'].forEach(s=>{ document.getElementById('vi-chk-'+s).textContent=' '; });
  document.getElementById('vi-chk-'+shape).textContent='✓';
}

// ── Drag ──────────────────────────────────────────────────
function dragStart(e,d){
  if(!e.active)simulation.alphaTarget(0.3).restart();
  d._dragging=true; d.fx=d.x; d.fy=d.y;
}
function dragged(e,d){d.fx=e.x;d.fy=e.y;}
function dragEnd(e,d){
  if(!e.active)simulation.alphaTarget(0);
  d._dragging=false;
  if(!d.pinned){d.fx=null;d.fy=null;}
}

// ── Node Selection (single click) ─────────────────────────
function selectNode(nodeId) {
  selectedNodeId = nodeId;
  nodeLayer.selectAll('.node-group').classed('selected-node', d => d.id === nodeId);
  showProperties(nodeId);
  // Switch to properties tab
  switchOverlayTab('properties');
}

// ── Tooltip ────────────────────────────────────────────────
function showTooltip(e,d) {
  const tip=document.getElementById('tooltip');
  const tc=getNodeColor(d);
  let html=`<span class="tt-name">${d.name}</span>`;
  if(d.type)html+=`<div class="tt-row"><span class="tt-key">Type</span><span class="type-badge" style="background:${tc}18;color:${tc};border:1px solid ${tc}44">${d.type}</span></div>`;
  if(d.status)html+=`<div class="tt-row"><span class="tt-key">Status</span><span class="tt-val" style="color:${STATUS_COLORS[d.status]||'#888'}">${d.status}</span></div>`;
  if(d.owners?.length)html+=`<div class="tt-row"><span class="tt-key">Owner</span><span class="tt-val">${d.owners.join(', ')}</span></div>`;
  html+=`<div class="tt-row"><span class="tt-key">Importance</span><span class="tt-val">${d.importance}</span></div>`;
  const conn=(d.linksOut||[]).length+(d.linksIn||[]).length;
  html+=`<div class="tt-row"><span class="tt-key">Links</span><span class="tt-val">${conn}</span></div>`;
  if(d.tags?.length)html+=`<div class="tt-row"><span class="tt-key">Tags</span><span class="tt-val">${d.tags.join(', ')}</span></div>`;
  if(d.notes)html+=`<div class="tt-row" style="margin-top:4px;"><span class="tt-val" style="opacity:0.55;font-size:9px;">${d.notes.substring(0,80)}${d.notes.length>80?'…':''}</span></div>`;
  tip.innerHTML=html; tip.classList.add('show');
}
function moveTooltip(e){const tip=document.getElementById('tooltip');tip.style.left=(e.clientX+15)+'px';tip.style.top=(e.clientY-12)+'px';}
function hideTooltip(){document.getElementById('tooltip').classList.remove('show');}

// ── Properties Panel ───────────────────────────────────────
function showProperties(nodeId) {
  const n=nodes.find(x=>x.id===nodeId);
  const emptyEl=document.getElementById('prop-panel-empty');
  const contentEl=document.getElementById('prop-panel-content');
  if(!n){emptyEl.style.display='flex';contentEl.style.display='none';return;}
  emptyEl.style.display='none';
  contentEl.style.display='block';
  const tc=getNodeColor(n);
  const totalConn=(n.linksOut||[]).length+(n.linksIn||[]).length;
  let html='';
  html+=`<div class="prop-name">${n.name}</div>`;
  // Badges
  html+='<div class="prop-badges">';
  if(n.type)html+=`<span class="prop-badge" style="background:${tc}18;color:${tc};border:1px solid ${tc}44">${n.type}</span>`;
  if(n.status)html+=`<span class="prop-badge" style="background:${(STATUS_COLORS[n.status]||'#888')}18;color:${STATUS_COLORS[n.status]||'#888'};border:1px solid ${(STATUS_COLORS[n.status]||'#888')}44">${n.status}</span>`;
  if(n.pinned)html+=`<span class="prop-badge" style="background:rgba(34,3,255,0.12);color:#4433ff;border:1px solid rgba(34,3,255,0.3)">Pinned</span>`;
  html+='</div>';
  // Importance bar
  html+=`<div class="prop-imp-bar">
    <div class="prop-imp-label"><span>Importance</span><span>${n.importance}</span></div>
    <div class="prop-imp-track"><div class="prop-imp-fill" style="width:${n.importance}%"></div></div>
  </div>`;
  // Details
  html+='<div class="prop-section"><div class="prop-section-title">Details</div>';
  if(n.owners?.length)html+=`<div class="prop-row"><span class="prop-row-key">Owner</span><span class="prop-row-val">${n.owners.join(', ')}</span></div>`;
  html+=`<div class="prop-row"><span class="prop-row-key">Connections</span><span class="prop-row-val">${totalConn} (${(n.linksOut||[]).length} out / ${(n.linksIn||[]).length} in)</span></div>`;
  if(n.createdAt)html+=`<div class="prop-row"><span class="prop-row-key">Created</span><span class="prop-row-val">${new Date(n.createdAt).toLocaleDateString()}</span></div>`;
  if(n.updatedAt)html+=`<div class="prop-row"><span class="prop-row-key">Updated</span><span class="prop-row-val">${new Date(n.updatedAt).toLocaleDateString()}</span></div>`;
  html+='</div>';
  // Tags
  if(n.tags?.length){
    html+='<div class="prop-section"><div class="prop-section-title">Tags</div><div class="prop-tags-wrap">';
    n.tags.forEach(t=>html+=`<span class="prop-tag">${t}</span>`);
    html+='</div></div>';
  }
  // Notes
  if(n.notes){
    html+=`<div class="prop-section"><div class="prop-section-title">Notes</div><div class="prop-notes">${n.notes}</div></div>`;
  }
  // Links out
  if((n.linksOut||[]).length){
    html+='<div class="prop-section"><div class="prop-section-title">Links Out →</div><div class="prop-links-list">';
    (n.linksOut||[]).forEach(tid=>{
      const tn=nodes.find(x=>x.id===tid);
      if(!tn)return;
      const label=n.linkMeta?.[tid]?.label?` · <em style="color:rgba(215,215,215,0.3);font-style:normal;font-size:8px;">${n.linkMeta[tid].label}</em>`:'';
      html+=`<div class="prop-link-row" onclick="selectNode('${tid}');openModal('${tid}')">
        <span class="prop-link-arrow">→</span><span>${tn.name}</span>${label}</div>`;
    });
    html+='</div></div>';
  }
  // Links in
  if((n.linksIn||[]).length){
    html+='<div class="prop-section"><div class="prop-section-title">Links In ←</div><div class="prop-links-list">';
    (n.linksIn||[]).forEach(sid=>{
      const sn=nodes.find(x=>x.id===sid);
      if(!sn)return;
      html+=`<div class="prop-link-row" onclick="selectNode('${sid}');openModal('${sid}')">
        <span class="prop-link-arrow" style="color:rgba(215,215,215,0.4);">←</span><span>${sn.name}</span></div>`;
    });
    html+='</div></div>';
  }
  // Custom properties
  if((n.custom||[]).length){
    html+='<div class="prop-section"><div class="prop-section-title">Properties</div><div class="prop-custom">';
    (n.custom||[]).forEach(c=>{
      if(c.key)html+=`<div class="prop-custom-row"><span class="prop-custom-key">${c.key}</span><span class="prop-custom-val">${c.val}</span></div>`;
    });
    html+='</div></div>';
  }
  html+=`<button class="prop-edit-btn" onclick="openModal('${n.id}')">Edit Node</button>`;
  contentEl.innerHTML=html;
}

// ── Search ─────────────────────────────────────────────────
document.getElementById('search').addEventListener('input',function(){
  const q=this.value.toLowerCase().trim();
  if(!q){
    nodeLayer.selectAll('.node-group').classed('dimmed',d=>!nodePassesFilters(d));
    linkLayer.selectAll('.link-path').attr('stroke-opacity',0.28);
    return;
  }
  nodeLayer.selectAll('.node-group').classed('dimmed',d=>!d.name.toLowerCase().includes(q));
  linkLayer.selectAll('.link-path').each(function(d){
    const sid=typeof d.source==='object'?d.source.id:d.source;
    const tid=typeof d.target==='object'?d.target.id:d.target;
    const sn=nodes.find(n=>n.id===sid),tn=nodes.find(n=>n.id===tid);
    const pass=(sn&&sn.name.toLowerCase().includes(q))||(tn&&tn.name.toLowerCase().includes(q));
    d3.select(this).attr('stroke-opacity',pass?0.5:0.04);
  });
});

// ── AUTOCOMPLETE (type/status) ─────────────────────────────
function initAutocomplete(inputId, suggestionsId, getOptions, getColor) {
  const inp=document.getElementById(inputId);
  const sug=document.getElementById(suggestionsId);
  function renderSugs(val) {
    const opts=getOptions(), q=val.toLowerCase().trim();
    const matches=opts.filter(o=>o.toLowerCase().includes(q));
    sug.innerHTML='';
    if(val && !opts.find(o=>o.toLowerCase()===q.toLowerCase())) {
      const d=document.createElement('div');d.className='ac-option';
      d.innerHTML=`<span style="font-size:9px;color:var(--accent)">+ Add</span><span class="ac-new">"${val}"</span>`;
      d.onclick=()=>{inp.value=val;sug.classList.remove('show');inp.blur();};
      sug.appendChild(d);
    }
    matches.forEach(o=>{
      const d=document.createElement('div');d.className='ac-option';
      const c=getColor?getColor(o):'#888';
      d.innerHTML=`<span class="ac-type-dot" style="background:${c}"></span>${o}`;
      d.onclick=()=>{inp.value=o;sug.classList.remove('show');inp.blur();};
      sug.appendChild(d);
    });
    sug.classList.toggle('show',!!(sug.children.length));
  }
  inp.addEventListener('focus',()=>renderSugs(inp.value));
  inp.addEventListener('input',()=>renderSugs(inp.value));
  inp.addEventListener('blur',()=>setTimeout(()=>sug.classList.remove('show'),180));
  inp.addEventListener('keydown',e=>{
    if(e.key==='Enter'){
      e.preventDefault();
      const val=inp.value.trim();
      if(val){
        const allOpts=getOptions();
        if(!allOpts.find(o=>o.toLowerCase()===val.toLowerCase())){
          if(inputId==='m-type')customTypes.push(val);
          else if(inputId==='m-status')customStatuses.push(val);
        }
        sug.classList.remove('show');
      }
    }
  });
}

// ── Tag chip helpers ───────────────────────────────────────
function makeChipSystem(chipsId, inputId, arrayRef, arrayName) {
  const wrap=document.getElementById(chipsId)?.parentElement || document.getElementById(chipsId+'s')?.parentElement;
  function renderChips() {
    const chipsEl=document.getElementById(chipsId);
    if(!chipsEl)return;
    chipsEl.innerHTML='';
    (window[arrayName]||[]).forEach((item,i)=>{
      const chip=document.createElement('span');chip.className='tag-chip';
      chip.innerHTML=`${item}<button class="tag-chip-rm">✕</button>`;
      chip.querySelector('.tag-chip-rm').onclick=()=>{window[arrayName].splice(i,1);renderChips();};
      chipsEl.appendChild(chip);
    });
  }
  const inp=document.getElementById(inputId);
  if(!inp)return;
  inp.addEventListener('keydown',e=>{
    if(e.key==='Enter'||e.key===','){
      e.preventDefault();
      const val=inp.value.trim().replace(/,/g,'');
      if(val&&!(window[arrayName]||[]).includes(val)){(window[arrayName]=window[arrayName]||[]).push(val);renderChips();}
      inp.value='';
    }
    if(e.key==='Backspace'&&!inp.value&&(window[arrayName]||[]).length){window[arrayName].pop();renderChips();}
  });
  return renderChips;
}

// ── Modal ──────────────────────────────────────────────────
function openModal(nodeId) {
  hideTooltip();
  editingNodeId=nodeId;
  const node=nodes.find(n=>n.id===nodeId),isNew=!node;
  const n=node||{
    id:nodeId,name:'',importance:50,color:PASTEL_PRESETS[0],
    linksOut:[],linksIn:[],notes:'',custom:[],
    type:'',status:'',owners:[],tags:[],linkMeta:{},pinned:false
  };
  document.getElementById('modal-title').innerHTML=isNew?'Add <span class="accent">Node</span>':'Edit <span class="accent">Node</span>';
  document.getElementById('m-name').value=n.name;
  document.getElementById('m-type').value=n.type||'';
  document.getElementById('m-status').value=n.status||'';
  document.getElementById('m-importance').value=n.importance;
  document.getElementById('m-importance-val').textContent=n.importance;
  document.getElementById('m-color').value=n.color||'#2203ff';
  document.getElementById('m-notes').value=n.notes||'';
  document.getElementById('m-pinned').checked=!!n.pinned;

  // owners
  currentOwners=[...(n.owners||[])];
  renderOwnerChips();
  // tags
  currentTags=[...(n.tags||[])];
  renderTagChips();

  // Color presets
  const presetsEl=document.getElementById('color-presets');presetsEl.innerHTML='';
  PASTEL_PRESETS.forEach(c=>{
    const div=document.createElement('div');
    div.style.cssText=`width:16px;height:16px;border-radius:2px;cursor:pointer;flex-shrink:0;background:${c};border:2px solid transparent;transition:all 0.12s;`;
    div.title=c; div.onclick=()=>document.getElementById('m-color').value=c;
    div.onmouseenter=()=>div.style.transform='scale(1.25)';
    div.onmouseleave=()=>div.style.transform='';
    presetsEl.appendChild(div);
  });

  // Links
  const others=nodes.filter(x=>x.id!==nodeId);
  fillSelect('m-links-out',others,n.linksOut||[],n);
  fillSelect('m-links-in',others,n.linksIn||[],null);
  updateLinkRelsList(n);

  // Custom props
  const cpl=document.getElementById('custom-props-list');cpl.innerHTML='';
  (n.custom||[]).forEach(c=>addCustomPropRow(c.key,c.val));

  document.getElementById('btn-delete-node').style.display=isNew?'none':'inline-flex';
  document.getElementById('btn-undo-del').style.display=lastDeleted?'inline-flex':'none';

  // Meta
  const metaEl=document.getElementById('modal-meta');metaEl.innerHTML='';
  if(!isNew){
    if(n.createdAt)metaEl.innerHTML+=`<span>Created: ${new Date(n.createdAt).toLocaleDateString()}</span>`;
    if(n.updatedAt)metaEl.innerHTML+=`<span>Updated: ${new Date(n.updatedAt).toLocaleDateString()}</span>`;
  }

  document.getElementById('modal-overlay').classList.add('show');
  setTimeout(()=>document.getElementById('m-name').focus(),80);
}

function renderOwnerChips() {
  const el=document.getElementById('m-owner-chips');if(!el)return;
  el.innerHTML='';
  currentOwners.forEach((o,i)=>{
    const chip=document.createElement('span');chip.className='tag-chip';
    chip.innerHTML=`${o}<button class="tag-chip-rm">✕</button>`;
    chip.querySelector('.tag-chip-rm').onclick=()=>{currentOwners.splice(i,1);renderOwnerChips();};
    el.appendChild(chip);
  });
}
function renderTagChips() {
  const el=document.getElementById('m-tag-chips');if(!el)return;
  el.innerHTML='';
  currentTags.forEach((t,i)=>{
    const chip=document.createElement('span');chip.className='tag-chip';
    chip.innerHTML=`${t}<button class="tag-chip-rm">✕</button>`;
    chip.querySelector('.tag-chip-rm').onclick=()=>{currentTags.splice(i,1);renderTagChips();};
    el.appendChild(chip);
  });
}

document.getElementById('m-owner-input').addEventListener('keydown',e=>{
  if(e.key==='Enter'||e.key===','){
    e.preventDefault();
    const val=e.target.value.trim().replace(/,/g,'');
    if(val&&!currentOwners.includes(val)){currentOwners.push(val);renderOwnerChips();}
    e.target.value='';
  }
  if(e.key==='Backspace'&&!e.target.value&&currentOwners.length){currentOwners.pop();renderOwnerChips();}
});
document.getElementById('m-tag-input').addEventListener('keydown',e=>{
  if(e.key==='Enter'||e.key===','){
    e.preventDefault();
    const val=e.target.value.trim().replace(/,/g,'');
    if(val&&!currentTags.includes(val)){currentTags.push(val);renderTagChips();}
    e.target.value='';
  }
  if(e.key==='Backspace'&&!e.target.value&&currentTags.length){currentTags.pop();renderTagChips();}
});
['owner-wrap','tag-wrap'].forEach(id=>{
  const el=document.getElementById(id);
  if(el)el.addEventListener('click',()=>{const inp=el.querySelector('.tag-chip-input');if(inp)inp.focus();});
});

function fillSelect(selId, others, selectedIds, nodeForMeta) {
  const sel=document.getElementById(selId);sel.innerHTML='';
  const nullOpt=document.createElement('option');
  nullOpt.value='__none__';nullOpt.textContent='— none —';
  nullOpt.style.color='rgba(215,215,215,0.3)';nullOpt.style.fontStyle='italic';
  nullOpt.selected=!(selectedIds&&selectedIds.length>0);
  sel.appendChild(nullOpt);
  others.forEach(o=>{
    const opt=document.createElement('option');opt.value=o.id;
    opt.textContent=(o.type?`[${o.type.substring(0,3).toUpperCase()}] `:'')+o.name;
    opt.selected=(selectedIds||[]).includes(o.id);
    sel.appendChild(opt);
  });
}

function updateLinkRelsList(n) {
  const linksOutSel=document.getElementById('m-links-out');
  const selected=[...linksOutSel.selectedOptions].map(o=>o.value).filter(v=>v&&v!=='__none__');
  const wrap=document.getElementById('link-rels-wrap');
  const list=document.getElementById('link-rels-list');list.innerHTML='';
  if(!selected.length){wrap.style.display='none';return;}
  wrap.style.display='block';
  selected.forEach(tid=>{
    const tn=nodes.find(x=>x.id===tid);if(!tn)return;
    const existing=(n&&n.linkMeta&&n.linkMeta[tid])?n.linkMeta[tid].label:'';
    const row=document.createElement('div');row.className='link-rel-row';
    row.innerHTML=`<span class="link-rel-arrow">→</span>
      <span class="link-rel-name">${tn.name}</span>
      <input type="text" class="link-rel-input" data-tid="${tid}" placeholder="governs, requires…" value="${existing}">`;
    list.appendChild(row);
  });
}

document.getElementById('m-links-out').addEventListener('change',function(){
  const none=[...this.options].find(o=>o.value==='__none__');
  if(none){const anyReal=[...this.options].filter(o=>o.value!=='__none__'&&o.selected).length>0;none.selected=!anyReal;}
  const curNode=nodes.find(n=>n.id===editingNodeId);
  updateLinkRelsList(curNode||null);
});
document.getElementById('m-links-in').addEventListener('change',function(){
  const none=[...this.options].find(o=>o.value==='__none__');
  if(none){const anyReal=[...this.options].filter(o=>o.value!=='__none__'&&o.selected).length>0;none.selected=!anyReal;}
});

function addCustomPropRow(key='',val='') {
  const row=document.createElement('div');row.className='custom-prop-row';
  row.innerHTML=`<input type="text" placeholder="Property" value="${key}">
    <input type="text" placeholder="Value" value="${val}">
    <button class="rm-prop" title="Remove">✕</button>`;
  row.querySelector('.rm-prop').onclick=()=>gsap.to(row,{height:0,opacity:0,marginBottom:0,duration:0.18,onComplete:()=>row.remove()});
  document.getElementById('custom-props-list').appendChild(row);
  gsap.from(row,{opacity:0,y:-5,duration:0.2,ease:'back.out(2)'});
}

// Importance slider
document.getElementById('m-importance').addEventListener('input',function(){
  document.getElementById('m-importance-val').textContent=this.value;
  this.style.background=`linear-gradient(to right, var(--accent) 0%, var(--accent) ${this.value}%, rgba(215,215,215,0.1) ${this.value}%, rgba(215,215,215,0.1) 100%)`;
});

function closeModal() { document.getElementById('modal-overlay').classList.remove('show'); editingNodeId=null; }

function saveNode() {
  const nameEl=document.getElementById('m-name');
  const name=nameEl.value.trim();
  if(!name){nameEl.style.borderColor='var(--red)';nameEl.focus();return;}
  nameEl.style.borderColor='';
  const importance=+document.getElementById('m-importance').value;
  const color=document.getElementById('m-color').value;
  const notes=document.getElementById('m-notes').value.trim();
  const type=document.getElementById('m-type').value.trim();
  const status=document.getElementById('m-status').value.trim();
  const pinned=document.getElementById('m-pinned').checked;

  if(type&&!DEFAULT_TYPES.includes(type)&&!customTypes.includes(type))customTypes.push(type);
  if(status&&!DEFAULT_STATUSES.includes(status)&&!customStatuses.includes(status))customStatuses.push(status);

  const selOut=[...document.getElementById('m-links-out').selectedOptions].map(o=>o.value).filter(v=>v&&v!=='__none__');
  const selIn=[...document.getElementById('m-links-in').selectedOptions].map(o=>o.value).filter(v=>v&&v!=='__none__');

  const linkMeta={};
  document.querySelectorAll('#link-rels-list .link-rel-input').forEach(inp=>{
    const tid=inp.dataset.tid,val=inp.value.trim();
    if(tid&&val)linkMeta[tid]={label:val};
  });

  const custom=[];
  document.querySelectorAll('#custom-props-list .custom-prop-row').forEach(row=>{
    const inputs=row.querySelectorAll('input');
    if(inputs[0].value.trim())custom.push({key:inputs[0].value.trim(),val:inputs[1].value.trim()});
  });

  const existing=nodes.find(n=>n.id===editingNodeId);
  if(existing){
    Object.assign(existing,{name,importance,color,notes,linksOut:selOut,custom,type,status,owners:currentOwners,tags:currentTags,linkMeta,pinned,updatedAt:now()});
    if(pinned){existing.fx=existing.x;existing.fy=existing.y;}
    else{existing.fx=null;existing.fy=null;}
  } else {
    nodes.push({id:editingNodeId,name,importance,color,notes,linksOut:selOut,linksIn:[],custom,type,status,owners:currentOwners,tags:currentTags,linkMeta,pinned,x:0,y:0,createdAt:now(),updatedAt:now()});
  }

  nodes.forEach(n=>{
    if(n.id===editingNodeId)return;
    const was=n.linksOut.includes(editingNodeId),should=selIn.includes(n.id);
    if(should&&!was)n.linksOut.push(editingNodeId);
    if(!should&&was)n.linksOut=n.linksOut.filter(id=>id!==editingNodeId);
  });

  closeModal();
  if(selectedNodeId===editingNodeId)showProperties(editingNodeId);
  updateGraph(true);
  notify(`✓  "${name}" saved`);
}

document.getElementById('btn-save-node').onclick=saveNode;
document.getElementById('btn-cancel').onclick=closeModal;
document.getElementById('modal-close').onclick=closeModal;
document.getElementById('modal-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('modal-overlay'))closeModal();});
document.getElementById('btn-add-prop').onclick=()=>addCustomPropRow();
document.getElementById('btn-delete-node').onclick=()=>{
  const n=nodes.find(x=>x.id===editingNodeId);if(!n)return;
  if(!confirm(`Delete "${n.name}"?`))return;
  const srcs=nodes.filter(x=>x.id!==editingNodeId&&x.linksOut.includes(editingNodeId)).map(x=>x.id);
  lastDeleted={node:JSON.parse(JSON.stringify(n)),incomingSources:srcs};
  nodes=nodes.filter(x=>x.id!==editingNodeId);
  nodes.forEach(x=>{x.linksOut=(x.linksOut||[]).filter(id=>id!==editingNodeId);});
  if(selectedNodeId===editingNodeId){selectedNodeId=null;document.getElementById('prop-panel-empty').style.display='flex';document.getElementById('prop-panel-content').style.display='none';}
  closeModal();updateGraph(true);notify('Node deleted — Ctrl+Z to undo');
};
document.getElementById('btn-undo-del').onclick=undoDelete;
function undoDelete() {
  if(!lastDeleted)return;
  nodes.push(lastDeleted.node);
  lastDeleted.incomingSources.forEach(sid=>{
    const src=nodes.find(n=>n.id===sid);
    if(src&&!src.linksOut.includes(lastDeleted.node.id))src.linksOut.push(lastDeleted.node.id);
  });
  lastDeleted=null;
  closeModal();updateGraph(true);notify('↩ Node restored');
}

// ── 3D GRAPH ───────────────────────────────────────────────
function enable3D() {
  if(isCluster){ disableCluster(); isCluster=false; document.getElementById('vi-chk-cluster').textContent=' '; }
  document.getElementById('graph').style.display='none';
  const c=document.getElementById('graph-3d');c.style.display='block';
  document.getElementById('mode-indicator').textContent='3D MODE';
  document.getElementById('mode-indicator').style.display='block';
  if(simulation)simulation.stop();

  const gData={
    nodes:nodes.map(n=>({id:n.id,name:n.name,importance:n.importance,type:n.type,color:getNodeColor(n),status:n.status})),
    links:links.map(l=>({
      source:typeof l.source==='object'?l.source.id:l.source,
      target:typeof l.target==='object'?l.target.id:l.target
    }))
  };

  try {
    graph3D=ForceGraph3D()(c)
      .graphData(gData)
      .backgroundColor(getComputedStyle(document.documentElement).getPropertyValue('--canvas-bg').trim()||'#050505')
      .nodeLabel(n=>n.name)
      .nodeColor(n=>n.color||'#2203ff')
      .nodeVal(n=>Math.max(1,(n.importance/100)*8+1))
      .nodeOpacity(0.9)
      .nodeResolution(12)
      .linkColor(()=>'rgba(34,3,255,0.5)')
      .linkOpacity(0.4)
      .linkWidth(0.5)
      .linkDirectionalArrowLength(4)
      .linkDirectionalArrowColor(()=>'rgba(34,3,255,0.8)')
      .linkDirectionalArrowRelPos(1)
      .linkDirectionalParticles(2)
      .linkDirectionalParticleColor(l=>{
        const sid=typeof l.source==='object'?l.source.id:l.source;
        const sn=nodes.find(n=>n.id===sid);
        return sn?getNodeColor(sn):'#2203ff';
      })
      .linkDirectionalParticleWidth(1.5)
      .linkDirectionalParticleSpeed(0.005)
      .onNodeClick(n=>{selectNode(n.id);openModal(n.id);})
      .onNodeHover(n=>{document.getElementById('graph-3d').style.cursor=n?'pointer':'default';});
  } catch(e) {
    console.warn('3D graph init failed:',e);
    notify('⚠ 3D mode unavailable. Check network.');
    disable3D(); is3D=false;
    document.getElementById('vi-chk-3d').textContent=' ';
  }
}

function disable3D() {
  document.getElementById('graph').style.display='';
  const c=document.getElementById('graph-3d');c.style.display='none';
  document.getElementById('mode-indicator').style.display='none';
  if(graph3D){try{c.innerHTML='';}catch(e){}graph3D=null;}
  if(simulation)simulation.alpha(0.3).restart();
}

function refresh3D() {
  if(!graph3D)return;
  graph3D.graphData({
    nodes:nodes.map(n=>({id:n.id,name:n.name,importance:n.importance,type:n.type,color:getNodeColor(n),status:n.status})),
    links:links.map(l=>({
      source:typeof l.source==='object'?l.source.id:l.source,
      target:typeof l.target==='object'?l.target.id:l.target
    }))
  });
}

// ── QUICK SWITCHER ─────────────────────────────────────────
function openQS() {
  document.getElementById('qs-overlay').classList.add('show');
  const inp=document.getElementById('qs-input');inp.value='';inp.focus();
  qsSelectedIndex=-1;renderQSResults('');
}
function closeQS() {document.getElementById('qs-overlay').classList.remove('show');}
function renderQSResults(q) {
  const list=document.getElementById('qs-list');list.innerHTML='';
  qsSelectedIndex=-1;
  if(!nodes.length){list.innerHTML='<div class="qs-empty">No nodes yet.</div>';return;}
  const results=q?nodes.filter(n=>n.name.toLowerCase().includes(q.toLowerCase())).slice(0,10):[...nodes].sort((a,b)=>b.importance-a.importance).slice(0,10);
  if(!results.length){list.innerHTML=`<div class="qs-empty">No match for "${q}"</div>`;return;}
  results.forEach(n=>{
    const row=document.createElement('div');row.className='qs-row';row.dataset.id=n.id;
    const tc=getNodeColor(n);
    const typeHtml=n.type?`<span class="qs-type" style="background:${tc}18;color:${tc};border:1px solid ${tc}44">${n.type}</span>`:'';
    const nameHtml=q?n.name.replace(new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'),'<em>$1</em>'):n.name;
    row.innerHTML=`<span class="qs-dot" style="background:${tc}"></span>${typeHtml}<span class="qs-name">${nameHtml}</span><span class="qs-status">${n.status||''}</span><span class="qs-imp">${n.importance}</span>`;
    row.onclick=()=>{closeQS();selectNode(n.id);openModal(n.id);};
    list.appendChild(row);
  });
}
document.getElementById('qs-input').addEventListener('input',function(){renderQSResults(this.value);});
document.getElementById('qs-input').addEventListener('keydown',function(e){
  const rows=document.querySelectorAll('.qs-row');
  if(e.key==='ArrowDown'){e.preventDefault();qsSelectedIndex=Math.min(qsSelectedIndex+1,rows.length-1);}
  else if(e.key==='ArrowUp'){e.preventDefault();qsSelectedIndex=Math.max(qsSelectedIndex-1,0);}
  else if(e.key==='Enter'){if(qsSelectedIndex>=0&&rows[qsSelectedIndex])rows[qsSelectedIndex].click();else if(rows.length===1)rows[0].click();return;}
  rows.forEach((r,i)=>r.classList.toggle('selected',i===qsSelectedIndex));
});
document.getElementById('qs-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('qs-overlay'))closeQS();});

// ── HELP ──────────────────────────────────────────────────
function openHelp(){document.getElementById('help-overlay').classList.add('show');}
function closeHelp(){document.getElementById('help-overlay').classList.remove('show');}
document.getElementById('help-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('help-overlay'))closeHelp();});

// ── FOCUS MODE ─────────────────────────────────────────────
function enterFocusMode(nodeId) {
  focusNodeId=nodeId;
  document.getElementById('btn-focus-exit').style.display='block';
  document.getElementById('focus-indicator').style.display='inline';
  simulation.alpha(0.1).restart();
}
function exitFocusMode() {
  focusNodeId=null;
  document.getElementById('btn-focus-exit').style.display='none';
  document.getElementById('focus-indicator').style.display='none';
  simulation.alpha(0.05).restart();
}
document.getElementById('btn-focus-exit').onclick=exitFocusMode;

// ── OVERLAY TABS ───────────────────────────────────────────
function switchOverlayTab(tab) {
  document.querySelectorAll('.ov-tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===tab));
  document.querySelectorAll('.ov-tab-content').forEach(c=>c.classList.toggle('active',c.id===`ov-tab-${tab}`));
  activeOverlayTab=tab;
  if(tab==='tags')updateTagsTab();
  if(tab==='stats')updateStatsTab();
  if(tab==='properties'&&selectedNodeId)showProperties(selectedNodeId);
}
document.querySelectorAll('.ov-tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>switchOverlayTab(btn.dataset.tab));
});

// ── FILTER BAR ─────────────────────────────────────────────
function buildTypeChips() {
  const container=document.getElementById('type-chips');
  const tc={};nodes.forEach(n=>{const t=n.type||'';tc[t]=(tc[t]||0)+1;});
  const actTypes=allTypes().filter(t=>tc[t]);
  container.innerHTML=actTypes.map(t=>{
    const isA=filterTypes.has(t),c=TYPE_COLORS[t]||'#4433ff';
    return `<button class="fchip${isA?' active':''}" data-type="${t}" style="${isA?`background:${c}12;color:${c};border-color:${c}44;`:''}">${t}<span class="fcount">${tc[t]}</span></button>`;
  }).join('');
  container.querySelectorAll('.fchip[data-type]').forEach(btn=>{
    btn.onclick=()=>{
      const t=btn.dataset.type;
      if(filterTypes.has(t)){filterTypes.delete(t);}else{filterTypes.add(t);}
      buildTypeChips();applyFilters();
    };
  });
}

function buildStatusFilter() {
  const sel=document.getElementById('filter-status-sel');
  if(!sel)return;
  const cur=sel.value;
  sel.innerHTML='<option value="">All Statuses</option>';
  const statuses=new Set(nodes.map(n=>n.status).filter(Boolean));
  allStatuses().filter(s=>statuses.has(s)).forEach(s=>{
    const opt=document.createElement('option');opt.value=s;opt.textContent=s;
    if(s===cur)opt.selected=true;
    sel.appendChild(opt);
  });
}

function applyFilters() {
  document.getElementById('filter-status-sel').classList.toggle('active',!!filterStatus);
  simulation.alpha(0.03).restart();
}

document.getElementById('filter-status-sel').addEventListener('change',function(){filterStatus=this.value;this.classList.toggle('active',!!filterStatus);applyFilters();});
document.getElementById('filter-tag-input').addEventListener('input',function(){filterTagText=this.value.trim();applyFilters();});
document.getElementById('btn-orphan-filter').addEventListener('click',function(){filterOrphans=!filterOrphans;this.classList.toggle('active',filterOrphans);applyFilters();});
document.getElementById('btn-clear-filters').addEventListener('click',()=>{
  filterTypes.clear();filterStatus='';filterTagText='';filterOrphans=false;
  document.getElementById('filter-status-sel').value='';
  document.getElementById('filter-status-sel').classList.remove('active');
  document.getElementById('filter-tag-input').value='';
  document.getElementById('btn-orphan-filter').classList.remove('active');
  buildTypeChips();applyFilters();
});

// ── STATUS & OVERLAY ───────────────────────────────────────
function updateStatus() {
  document.getElementById('stat-nodes').textContent=nodes.length;
  document.getElementById('stat-links').textContent=links.length;
  const orphans=nodes.filter(n=>(!n.linksOut?.length)&&(!n.linksIn?.length)).length;
  document.getElementById('stat-orphans').textContent=orphans;
  const maxL=nodes.length*(nodes.length-1);
  document.getElementById('stat-density').textContent=maxL>0?((links.length/maxL)*100).toFixed(1)+'%':'—';
  updateOverlay();
}

function updateOverlay() {
  const list=document.getElementById('overlay-list');if(!list)return;
  list.innerHTML='';
  const sorted=[...nodes].sort((a,b)=>{
    const sA=a.importance+(a.linksOut||[]).length+(a.linksIn||[]).length;
    const sB=b.importance+(b.linksOut||[]).length+(b.linksIn||[]).length;
    return sB-sA||a.name.localeCompare(b.name);
  });
  sorted.forEach((n,i)=>{
    const tc=getNodeColor(n),conn=(n.linksOut||[]).length+(n.linksIn||[]).length;
    const typeHtml=n.type?`<span class="ov-type" style="background:${tc}12;color:${tc};border:1px solid ${tc}33">${n.type.substring(0,3).toUpperCase()}</span>`:'';
    const row=document.createElement('div');row.className='overlay-row'+(n.id===selectedNodeId?' selected':'');
    row.innerHTML=`<span class="ov-rank">${String(i+1).padStart(2,'0')}</span>
      <div class="ov-dot" style="background:${tc}"></div>
      ${typeHtml}
      <span class="ov-name" title="${n.name}">${n.name}</span>
      <span class="ov-imp">${n.importance}</span>
      <span class="ov-conn">${conn}</span>`;
    row.onclick=()=>{selectNode(n.id);};
    list.appendChild(row);
  });
  const panel=document.getElementById('overlay-panel');
  const toggle=document.getElementById('btn-overlay-toggle');
  if(nodes.length>0&&overlayVisible){panel.classList.add('visible');toggle.style.right='296px';}
  else{panel.classList.remove('visible');toggle.style.right='0';}
  if(activeOverlayTab==='tags')updateTagsTab();
  if(activeOverlayTab==='stats')updateStatsTab();
  if(activeOverlayTab==='properties'&&selectedNodeId)showProperties(selectedNodeId);
}

function updateTagsTab() {
  const el=document.getElementById('tag-cloud');if(!el)return;
  const tc={};nodes.forEach(n=>(n.tags||[]).forEach(t=>{tc[t]=(tc[t]||0)+1;}));
  const sorted=Object.entries(tc).sort((a,b)=>b[1]-a[1]);
  if(!sorted.length){el.innerHTML='<div class="no-tags-hint">No tags yet.</div>';return;}
  el.innerHTML='';
  sorted.forEach(([tag,count])=>{
    const isA=filterTagText===tag;
    const item=document.createElement('div');item.className='tag-cloud-item'+(isA?' active':'');
    item.innerHTML=`${tag}<span class="tag-cloud-count">${count}</span>`;
    item.onclick=()=>{
      filterTagText=filterTagText===tag?'':(tag);
      document.getElementById('filter-tag-input').value=filterTagText;
      updateTagsTab();applyFilters();
    };
    el.appendChild(item);
  });
}

function updateStatsTab() {
  const el=document.getElementById('ov-stats-content');if(!el)return;
  const n=nodes.length,l=links.length;
  const orphans=nodes.filter(nd=>(!nd.linksOut?.length)&&(!nd.linksIn?.length)).length;
  const avgDeg=n>0?(l*2/n).toFixed(1):'0';
  const maxL=n*(n-1);
  const density=maxL>0?((l/maxL)*100).toFixed(1)+'%':'—';
  const avgImp=n>0?(nodes.reduce((a,b)=>a+b.importance,0)/n).toFixed(1):'—';
  const maxImpNode=nodes.reduce((m,nd)=>nd.importance>m.importance?nd:m,{importance:-1,name:'—'});
  const hubs=nodes.filter(nd=>(nd.linksOut||[]).length+(nd.linksIn||[]).length>=3).length;
  const noType=nodes.filter(nd=>!nd.type).length;
  const noStatus=nodes.filter(nd=>!nd.status).length;
  const noNotes=nodes.filter(nd=>!nd.notes).length;
  const uniqueTags=new Set(nodes.flatMap(nd=>nd.tags||[])).size;

  const typeCounts={};nodes.forEach(nd=>{const t=nd.type||'(none)';typeCounts[t]=(typeCounts[t]||0)+1;});
  const statusCounts={};nodes.forEach(nd=>{const s=nd.status||'(none)';statusCounts[s]=(statusCounts[s]||0)+1;});
  const sortedTypes=Object.entries(typeCounts).sort((a,b)=>b[1]-a[1]);
  const sortedStatuses=Object.entries(statusCounts).sort((a,b)=>b[1]-a[1]);
  const maxTC=Math.max(...Object.values(typeCounts),1);
  const maxSC=Math.max(...Object.values(statusCounts),1);

  const sorted=[...nodes].sort((a,b)=>(b.linksOut?.length||0)+(b.linksIn?.length||0)-(a.linksOut?.length||0)-(a.linksIn?.length||0)).slice(0,6);

  // Build SVG pie chart for type distribution
  function buildPie(entries, colorFn, size=80) {
    if(!entries.length||!n) return '';
    const total=entries.reduce((s,[,c])=>s+c,0);
    if(!total) return '';
    const cx=size/2, cy=size/2, r=size/2-4, ir=r*0.45;
    let angle=-Math.PI/2, paths='', legends='';
    entries.forEach(([label, count])=>{
      const slice=(count/total)*Math.PI*2;
      const x1=cx+r*Math.cos(angle), y1=cy+r*Math.sin(angle);
      const x2=cx+r*Math.cos(angle+slice), y2=cy+r*Math.sin(angle+slice);
      const xi1=cx+ir*Math.cos(angle), yi1=cy+ir*Math.sin(angle);
      const xi2=cx+ir*Math.cos(angle+slice), yi2=cy+ir*Math.sin(angle+slice);
      const large=slice>Math.PI?1:0;
      const color=colorFn(label);
      paths+=`<path d="M${xi1},${yi1} L${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} L${xi2},${yi2} A${ir},${ir} 0 ${large},0 ${xi1},${yi1} Z" fill="${color}" opacity="0.85" stroke="none"/>`;
      angle+=slice;
    });
    // Center label
    const centerLabel=`<text x="${cx}" y="${cy+1}" text-anchor="middle" dominant-baseline="middle" font-family="Sunflower,sans-serif" font-size="9" font-weight="700" fill="rgba(215,215,215,0.7)">${total}</text>`;
    return `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">${paths}${centerLabel}</svg>`;
  }

  const typePie=buildPie(sortedTypes, t=>TYPE_COLORS[t]||'#4433ff', 90);
  const statusPie=buildPie(sortedStatuses, s=>STATUS_COLORS[s]||'#888', 90);

  function pieRow(pie, legendEntries, colorFn) {
    if(!n) return '<div style="font-size:9px;color:var(--text-muted);padding:8px 0;">No data</div>';
    const legends=legendEntries.slice(0,6).map(([label,count])=>{
      const c=colorFn(label);
      const pct=n?Math.round(count/n*100):0;
      return `<div style="display:flex;align-items:center;gap:5px;padding:1px 0;">
        <span style="width:6px;height:6px;border-radius:50%;background:${c};flex-shrink:0;display:inline-block;"></span>
        <span style="font-size:8px;color:rgba(215,215,215,0.5);font-weight:300;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${label}</span>
        <span style="font-size:8px;color:rgba(215,215,215,0.35);font-weight:500;min-width:22px;text-align:right;">${count}</span>
      </div>`;
    }).join('');
    return `<div style="display:flex;align-items:center;gap:10px;">${pie}<div style="flex:1;min-width:0;">${legends}</div></div>`;
  }

  el.innerHTML=`
  <div class="stats-section"><div class="stats-title">Graph Metrics</div>
    <div class="stats-row"><span class="sk">Nodes</span><span class="sv accent">${n}</span></div>
    <div class="stats-row"><span class="sk">Links</span><span class="sv accent">${l}</span></div>
    <div class="stats-row"><span class="sk">Avg Degree</span><span class="sv">${avgDeg}</span></div>
    <div class="stats-row"><span class="sk">Density</span><span class="sv">${density}</span></div>
    <div class="stats-row"><span class="sk">Hub Nodes (≥3)</span><span class="sv">${hubs}</span></div>
    <div class="stats-row"><span class="sk">Orphan Nodes</span><span class="sv ${orphans>0?'red':'green'}">${orphans}</span></div>
  </div>
  <div class="stats-section"><div class="stats-title">Importance</div>
    <div class="stats-row"><span class="sk">Average</span><span class="sv">${avgImp}</span></div>
    <div class="stats-row"><span class="sk">Highest</span><span class="sv accent">${maxImpNode.name!=='—'?maxImpNode.name+' ('+maxImpNode.importance+')':'—'}</span></div>
  </div>
  <div class="stats-section"><div class="stats-title">Coverage</div>
    <div class="stats-row"><span class="sk">Unique Tags</span><span class="sv">${uniqueTags}</span></div>
    <div class="stats-row"><span class="sk">No Type</span><span class="sv ${noType>0?'red':'green'}">${noType}</span></div>
    <div class="stats-row"><span class="sk">No Status</span><span class="sv ${noStatus>0?'red':'green'}">${noStatus}</span></div>
    <div class="stats-row"><span class="sk">No Notes</span><span class="sv ${noNotes>2?'':'green'}">${noNotes}</span></div>
  </div>
  <div class="stats-section"><div class="stats-title">Type Distribution</div>
    ${n ? pieRow(typePie, sortedTypes, t=>TYPE_COLORS[t]||'#4433ff') : '<div style="font-size:9px;color:var(--text-muted);">No data</div>'}
  </div>
  <div class="stats-section"><div class="stats-title">Status Distribution</div>
    ${n ? pieRow(statusPie, sortedStatuses, s=>STATUS_COLORS[s]||'#888') : '<div style="font-size:9px;color:var(--text-muted);">No data</div>'}
  </div>
  <div class="stats-section"><div class="stats-title">Most Connected</div>
    ${sorted.map(nd=>{
      const conn=(nd.linksOut||[]).length+(nd.linksIn||[]).length;
      const tc2=getNodeColor(nd);
      const impPct=nd.importance;
      return `<div class="stats-top-row" onclick="selectNode('${nd.id}');switchOverlayTab('properties')">
        <span class="stats-top-name" style="color:${tc2}bb">${nd.name}</span>
        <span class="stats-top-val">${conn} · <span style="color:var(--accent-hi)">${impPct}</span></span>
      </div>`;
    }).join('')}
  </div>`;
}

function updateEmptyHint() {
  const h=document.getElementById('empty-hint');
  h.style.opacity=nodes.length===0?'1':'0';
  h.style.pointerEvents=nodes.length===0?'auto':'none';
}

// ── Overlay toggle ─────────────────────────────────────────
document.getElementById('btn-overlay-toggle').onclick=()=>{
  overlayVisible=!overlayVisible;
  const panel=document.getElementById('overlay-panel');
  const toggle=document.getElementById('btn-overlay-toggle');
  const chevron=document.getElementById('overlay-chevron');
  if(overlayVisible){panel.classList.add('visible');toggle.style.right='296px';chevron.setAttribute('d','M6.5 1L1.5 6.5L6.5 12');}
  else{panel.classList.remove('visible');toggle.style.right='0';chevron.setAttribute('d','M2 1L7 6.5L2 12');}
};

// ── SVG click to deselect ──────────────────────────────────
document.getElementById('graph').addEventListener('click',e=>{
  if(e.target===document.getElementById('graph')||e.target.id==='zoom-layer'){
    selectedNodeId=null;
    nodeLayer.selectAll('.node-group').classed('selected-node',false);
    document.getElementById('prop-panel-empty').style.display='flex';
    document.getElementById('prop-panel-content').style.display='none';
  }
});

// ── ZOOM ──────────────────────────────────────────────────
function doZoomFit() {
  if(!nodes.length||!zoomBehavior||is3D)return;
  const svgEl=svg2D.node(),W=svgEl.clientWidth,H=svgEl.clientHeight,pad=60;
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  nodes.forEach(n=>{const r=nodeRadius(n.importance);minX=Math.min(minX,n.x-r);minY=Math.min(minY,n.y-r);maxX=Math.max(maxX,n.x+r);maxY=Math.max(maxY,n.y+r);});
  const bw=maxX-minX||1,bh=maxY-minY||1;
  const scale=Math.min(0.92,(W-pad*2)/bw,(H-pad*2)/bh);
  const tx=W/2-scale*(minX+bw/2),ty=H/2-scale*(minY+bh/2);
  svg2D.transition().duration(500).ease(d3.easeCubicInOut)
    .call(zoomBehavior.transform,d3.zoomIdentity.translate(tx,ty).scale(scale));
}
document.getElementById('btn-zoom-fit').onclick=doZoomFit;
// zoom-fit-tb removed from toolbar — only in bottom-left canvas button

// ── TOOLBAR ACTIONS ────────────────────────────────────────
document.getElementById('btn-add').onclick=()=>openModal(uid());
document.getElementById('btn-reset-layout').onclick=()=>{
  nodes.forEach(n=>{if(!n.pinned){n.x=(Math.random()-0.5)*300;n.y=(Math.random()-0.5)*300;n.vx=0;n.vy=0;}});
  simulation.alpha(1).restart();notify('Layout reset');
};
document.getElementById('btn-toggle-filters').addEventListener('click',function(){
  filterBarVisible=!filterBarVisible;
  document.getElementById('filter-bar').classList.toggle('hidden',!filterBarVisible);
  this.classList.toggle('active',filterBarVisible);
});
document.getElementById('btn-help').onclick=openHelp;
document.getElementById('btn-import-json').onclick=()=>document.getElementById('file-input').click();

// ── VISUALS DROPDOWN ───────────────────────────────────────
const visualsPanel=document.getElementById('visuals-panel');
document.getElementById('btn-visuals').onclick=e=>{e.stopPropagation();visualsPanel.classList.toggle('show');};
document.addEventListener('click',e=>{
  if(!document.getElementById('visuals-wrap').contains(e.target))visualsPanel.classList.remove('show');
  if(!document.getElementById('save-wrap').contains(e.target))document.getElementById('save-panel').classList.remove('show');
});

document.getElementById('vi-shape-circle').onclick=()=>{applyNodeShape('circle');['circle','outline','rect'].forEach(s=>document.getElementById('vi-chk-'+s).textContent=' ');document.getElementById('vi-chk-circle').textContent='✓';visualsPanel.classList.remove('show');notify('Filled circles');};
document.getElementById('vi-shape-outline').onclick=()=>{applyNodeShape('outline');['circle','outline','rect'].forEach(s=>document.getElementById('vi-chk-'+s).textContent=' ');document.getElementById('vi-chk-outline').textContent='✓';visualsPanel.classList.remove('show');notify('Outline circles');};
document.getElementById('vi-shape-rect').onclick=()=>{applyNodeShape('rect');['circle','outline','rect'].forEach(s=>document.getElementById('vi-chk-'+s).textContent=' ');document.getElementById('vi-chk-rect').textContent='✓';visualsPanel.classList.remove('show');notify('Card nodes');};

document.getElementById('vi-color-type').addEventListener('click',function(){
  colorByType=!colorByType;
  document.getElementById('vi-chk-ctype').textContent=colorByType?'✓':' ';
  updateNodeStyle(nodeLayer.selectAll('.node-group'));
  updateLinkStyle(linkLayer.selectAll('.link-path'));
  if(is3D)refresh3D();
  else simulation.alpha(0.05).restart();
  notify(colorByType?'Color by type':'Custom colors');
});

const bgColorInput=document.getElementById('bg-color-input');
const bgSwatch=document.getElementById('bg-color-swatch');
function setCanvasBg(color){
  document.documentElement.style.setProperty('--canvas-bg',color);
  bgSwatch.style.background=color;bgColorInput.value=color;
  if(is3D&&graph3D)graph3D.backgroundColor(color);
}
setCanvasBg('#050505');
bgColorInput.addEventListener('input',e=>setCanvasBg(e.target.value));
bgColorInput.addEventListener('change',e=>setCanvasBg(e.target.value));

// Links button: toggle particle animation on/off
document.getElementById('btn-links-toggle').addEventListener('click', function() {
  linksAnimating = !linksAnimating;
  this.classList.toggle('active', !linksAnimating);
  // Swap icon between pause and play
  this.querySelector('svg').innerHTML = linksAnimating
    ? '<path d="M2 2h2.5v8H2zM7.5 2H10v8H7.5z" fill="currentColor" opacity="0.7"/>'
    : '<path d="M2 2l9 4.5L2 11V2z" fill="currentColor" opacity="0.8"/>';
  // Keep simulation ticking so positions update; particles just freeze
  if (!linksAnimating) simulation.alpha(0.01).restart();
  notify(linksAnimating ? 'Link animation resumed' : 'Link animation paused');
});

document.getElementById('vi-3d').addEventListener('click',function(){
  if(isCluster){ disableCluster(); isCluster=false; document.getElementById('vi-chk-cluster').textContent=' '; }
  is3D=!is3D;
  document.getElementById('vi-chk-3d').textContent=is3D?'✓':' ';
  if(is3D)enable3D();
  else{disable3D();simulation.alpha(0.3).restart();}
  visualsPanel.classList.remove('show');
  notify(is3D?'3D force graph activated':'Back to 2D');
});

// ── CLUSTER VIEW ───────────────────────────────────────────
// Groups nodes by Type using custom D3 cluster forces.
// Each type gets a centroid; nodes are attracted toward their type's centroid.

const TYPE_ORDER_LIST = ['Policy','Standard','Regulation','Process','Role','System','Risk','Control','Asset','Objective'];

function getClusterCentroids() {
  const W = svg2D.node().clientWidth, H = svg2D.node().clientHeight;
  const types = [...new Set(nodes.map(n=>n.type||'(none)'))];
  const count = types.length || 1;
  const R = Math.min(W,H) * 0.28;
  const cx = 0, cy = 0;
  const centroids = {};
  types.forEach((t,i)=>{
    const angle = (i/count)*Math.PI*2 - Math.PI/2;
    centroids[t] = { x: cx + R*Math.cos(angle), y: cy + R*Math.sin(angle) };
  });
  return centroids;
}

let clusterForceActive = false;
function clusterForce(alpha) {
  if(!clusterForceActive) return;
  const centroids = getClusterCentroids();
  const strength = 0.18;
  nodes.forEach(node=>{
    const t = node.type||'(none)';
    const c = centroids[t];
    if(!c) return;
    node.vx += (c.x - node.x) * alpha * strength;
    node.vy += (c.y - node.y) * alpha * strength;
  });
}

function enableCluster() {
  if(is3D){ disable3D(); is3D=false; document.getElementById('vi-chk-3d').textContent=' '; }
  clusterForceActive = true;
  document.getElementById('mode-indicator').textContent = 'CLUSTER MODE';
  document.getElementById('mode-indicator').style.display = 'block';
  // Weaken charge & link distance so cluster force dominates
  simulation
    .force('charge', d3.forceManyBody().strength(d => -60 - d.importance*0.8))
    .force('link', d3.forceLink().id(d=>d.id).distance(30).strength(0.15))
    .force('cluster', clusterForce)
    .alpha(0.9).restart();
  // Draw type centroid labels
  drawClusterLabels();
}

function disableCluster() {
  clusterForceActive = false;
  document.getElementById('mode-indicator').style.display = 'none';
  svg2D.select('#cluster-labels-layer').remove();
  // Restore original forces
  simulation
    .force('charge', d3.forceManyBody().strength(d => -150 - d.importance * 1.5))
    .force('link', d3.forceLink().id(d=>d.id).distance(d=>{
      const s=nodes.find(n=>n.id===(typeof d.source==='object'?d.source.id:d.source));
      const t=nodes.find(n=>n.id===(typeof d.target==='object'?d.target.id:d.target));
      const mi=s&&t?Math.min(s.importance,t.importance):50;
      return 60+mi*0.8;
    }).strength(0.4))
    .force('cluster', null)
    .alpha(0.6).restart();
}

function drawClusterLabels() {
  svg2D.select('#cluster-labels-layer').remove();
  const labelLayer = g.insert('g','#links-layer').attr('id','cluster-labels-layer');
  const centroids = getClusterCentroids();
  Object.entries(centroids).forEach(([type, pos])=>{
    const color = TYPE_COLORS[type] || '#4433ff';
    const typeNodes = nodes.filter(n=>(n.type||'(none)')===type);
    if(!typeNodes.length) return;
    const grp = labelLayer.append('g').attr('transform',`translate(${pos.x},${pos.y})`);
    // Background pill
    grp.append('ellipse')
      .attr('rx', 38).attr('ry', 13)
      .attr('fill', color).attr('opacity', 0.08)
      .attr('stroke', color).attr('stroke-width', 0.5).attr('stroke-opacity', 0.25);
    grp.append('text')
      .attr('text-anchor','middle').attr('dominant-baseline','middle')
      .attr('font-family',"'Sunflower','Helvetica Neue',sans-serif")
      .attr('font-size', 9).attr('font-weight', 500)
      .attr('fill', color).attr('opacity', 0.6)
      .text(type + ' (' + typeNodes.length + ')');
  });
}

document.getElementById('vi-cluster').addEventListener('click',function(){
  isCluster=!isCluster;
  document.getElementById('vi-chk-cluster').textContent=isCluster?'✓':' ';
  if(isCluster)enableCluster();
  else disableCluster();
  visualsPanel.classList.remove('show');
  notify(isCluster?'Type Clusters view activated':'Back to free layout');
});

// ── SAVE DROPDOWN ──────────────────────────────────────────
document.getElementById('btn-save-menu').onclick=e=>{e.stopPropagation();document.getElementById('save-panel').classList.toggle('show');};

function graphToJSON(){
  return JSON.stringify({version:'1.032',nodes:nodes.map(n=>({...n,vx:0,vy:0,fx:null,fy:null,_dragging:undefined})),links:[],customTypes,customStatuses},null,2);
}
function loadFromJSON(json) {
  const data=typeof json==='string'?JSON.parse(json):json;
  nodes=(data.nodes||[]).map(n=>({...n,linksOut:n.linksOut||[],linksIn:n.linksIn||[],custom:n.custom||[],tags:n.tags||[],owners:n.owners||[],linkMeta:n.linkMeta||{},x:n.x!=null?n.x:(Math.random()-0.5)*320,y:n.y!=null?n.y:(Math.random()-0.5)*320}));
  if(data.customTypes)customTypes=[...new Set([...customTypes,...data.customTypes])];
  if(data.customStatuses)customStatuses=[...new Set([...customStatuses,...data.customStatuses])];
  updateGraph(true);
}
function autoSave(){try{localStorage.setItem(STORAGE_KEY,graphToJSON());}catch(e){}}

document.getElementById('save-json').onclick=e=>{
  e.stopPropagation();document.getElementById('save-panel').classList.remove('show');
  const blob=new Blob([graphToJSON()],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='ecosystemos-governance.json';a.click();notify('JSON saved');
};
document.getElementById('save-svg').onclick=e=>{
  e.stopPropagation();document.getElementById('save-panel').classList.remove('show');
  if(is3D){notify('⚠ Switch to 2D to export SVG');return;}
  const svgEl=document.getElementById('graph'),ser=new XMLSerializer();
  let svgStr=ser.serializeToString(svgEl);
  const bg=getComputedStyle(document.documentElement).getPropertyValue('--canvas-bg').trim()||'#050505';
  svgStr=svgStr.replace('<svg',`<svg style="background:${bg}"`);
  const blob=new Blob([svgStr],{type:'image/svg+xml'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='ecosystemos-governance.svg';a.click();notify('SVG saved');
};
document.getElementById('save-ls').onclick=e=>{e.stopPropagation();document.getElementById('save-panel').classList.remove('show');autoSave();notify('Saved to browser');};
document.getElementById('load-ls').onclick=e=>{
  e.stopPropagation();document.getElementById('save-panel').classList.remove('show');
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw){notify('⚠  Nothing saved yet');return;}
  loadFromJSON(raw);notify('Loaded from browser');
};

document.getElementById('file-input').onchange=function(){
  const file=this.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{try{loadFromJSON(e.target.result);notify('↑ Imported '+file.name);}catch(err){alert('Invalid JSON: '+err.message);}};
  reader.readAsText(file);this.value='';
};
document.getElementById('canvas-wrap').addEventListener('dragover',e=>e.preventDefault());
document.getElementById('canvas-wrap').addEventListener('drop',e=>{
  e.preventDefault();const file=e.dataTransfer.files[0];
  if(!file||!file.name.endsWith('.json'))return;
  const reader=new FileReader();
  reader.onload=ev=>{try{loadFromJSON(ev.target.result);notify('↑ Dropped '+file.name);}catch(err){alert('Invalid JSON');}};
  reader.readAsText(file);
});

// ── KEYBOARD SHORTCUTS ─────────────────────────────────────
document.addEventListener('keydown',e=>{
  const tag=document.activeElement.tagName;
  const inInput=['INPUT','TEXTAREA','SELECT'].includes(tag);
  if((e.key==='k'||e.key==='K')&&(e.ctrlKey||e.metaKey)){e.preventDefault();openQS();return;}
  if(e.key==='Escape'){
    if(document.getElementById('help-overlay').classList.contains('show')){closeHelp();return;}
    if(document.getElementById('qs-overlay').classList.contains('show')){closeQS();return;}
    if(document.getElementById('modal-overlay').classList.contains('show')){closeModal();return;}
    if(focusNodeId){exitFocusMode();return;}
    visualsPanel.classList.remove('show');
    document.getElementById('save-panel').classList.remove('show');
    return;
  }
  if(inInput)return;
  if(e.key==='f'||e.key==='F'){if(hoveredNodeId)enterFocusMode(hoveredNodeId);else if(focusNodeId)exitFocusMode();return;}
  if(e.key==='?'){openHelp();return;}
  if((e.key==='z'||e.key==='Z')&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){e.preventDefault();if(lastDeleted)undoDelete();}
});

// ── INIT ───────────────────────────────────────────────────
window.addEventListener('load',()=>{
  initGraph();
  // Setup autocomplete for type & status
  initAutocomplete('m-type','m-type-suggestions',allTypes,t=>TYPE_COLORS[t]||'#4433ff');
  initAutocomplete('m-status','m-status-suggestions',allStatuses,s=>STATUS_COLORS[s]||'#888');
  // Init importance slider fill
  const impSlider=document.getElementById('m-importance');
  impSlider.style.background=`linear-gradient(to right, var(--accent) 0%, var(--accent) 50%, rgba(215,215,215,0.1) 50%, rgba(215,215,215,0.1) 100%)`;
  updateGraph(false);
});
window.addEventListener('resize',()=>{
  if(simulation)simulation.force('center',d3.forceCenter(0,0)).alpha(0.1).restart();
  if(overlayVisible&&nodes.length)document.getElementById('btn-overlay-toggle').style.right='296px';
  if(is3D&&graph3D){const c=document.getElementById('graph-3d');graph3D.width(c.clientWidth).height(c.clientHeight);}
});
</script>
</body>
</html>
